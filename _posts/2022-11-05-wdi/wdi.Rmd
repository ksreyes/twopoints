---
title: "Exercises in plotting WDI data"
date: 2022-11-05
output:
  distill::distill_article:
    self_contained: false
---

```{r setup, include=FALSE}
library(DiagrammeR)

knitr::opts_chunk$set(comment=NA, message=FALSE, warning=FALSE)
```

In the old days I used to download WDI datasets in Excel format and point-and-click my way to a neat little chart. Now I want to try using the `WDI` package and some `ggplot` wizardry.

```{r}
library(tidyverse)
library(ggplot2)
library(WDI)
```

### A simple line chart

To start, let's try plotting the GDP per capita of the Philippines and Vietnam in constant 2015 US$.

```{r}
df <- WDI(country = c("PH","VN"),
          indicator = "NY.GDP.PCAP.KD",
          start = 1990) %>% 
  as_tibble()

ggplot(df, aes(x = year, y = NY.GDP.PCAP.KD, color = country)) +
  geom_line()

```

Great. Now let's try to get a cleaner chart by removing everything we don't need: the axis labels, the legend title, the vertical grid lines, the tick marks. Then let's add a chart title.

```{r}
ggplot(df, aes(x = year, y = NY.GDP.PCAP.KD, color = country)) +
  geom_line() +
  labs(title = "GDP per capita in constant 2015 US$") +
  theme(text = element_text(size = 12),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "right",
        legend.title = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())

```

It's a serviceable chart, but not a particularly *attractive* chart. Let's spend some more time glamming it up. The numbers on the y-axis could use a thousands separator. The plot lines could be a little thicker. We can also make tweaks to the text sizes, the colors, the margins, and so forth.

```{r}
ggplot(df, aes(x = year, y = NY.GDP.PCAP.KD, color = country)) +
  geom_line(size = 1) +
  scale_color_manual(values = c("#007db7", "#E9532B")) + 
  labs(title = "GDP per capita in constant 2015 US$") +
  scale_y_continuous(label = function(x) prettyNum(x, big.mark = ",", scientific = FALSE)) + 
  theme(aspect.ratio = .7,
        axis.title = element_blank(),
        axis.text.x = element_text(size = 10, margin = margin(5, 0, 0, 0)),
        axis.text.y = element_text(size = 10, margin = margin(0, 5, 0, 0)),
        axis.ticks = element_blank(),
        plot.title = element_text(size = 12, hjust = .5, face = "bold", margin = margin(0, 0, 10, 0)),
        legend.text = element_text(size = 11),
        legend.position = "right",
        legend.title = element_blank(),
        panel.background = element_rect(fill = "gray97"),
        panel.grid.major.y = element_line(size = 1),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank())

```

Now this to me is an attractive chart! A document populated with charts like this---as opposed to charts like the first two above---would be much more motivating to read.


### A scatterplot

I think one useful way to categorize countries is according to whether they are big and rich, big and poor, small and rich, or small and poor. We can visualize this in a scatterplot with population on one axis and GDP per capita on the other. Let's load up the data.

```{r}
df <- WDI(country = "all",
          indicator = c("gpc" = "NY.GDP.PCAP.KD", 
                        "pop" = "SP.POP.TOTL"),
          start = 2015,
          end = 2015,
          extra = TRUE) %>% 
  as_tibble() %>%
  filter(region != "Aggregates") %>%
  select(country, gpc, pop) %>%
  drop_na()
```

This scatter 

```{r}
ggplot(df, aes(x = pop, y = gpc)) +
  geom_point()
```

What an atrocious chart! We'll need to re-express the axes in log scale first.

```{r}
ggplot(df, aes(x = log10(pop), y = log2(gpc))) +
  geom_point() + 
  scale_x_continuous(name = "Population",
                     breaks = c(log10(10^4), log10(10^5), log10(10^6), log10(10^7), log10(10^8), log10(10^9)),
                     label = c("10,000", "100,000", "1 million", "10 million", "100 million", "1 billion")) +
  scale_y_continuous(name = "GDP per capita constant 2015 US$",
                     breaks = c(log2(375), log2(1500), log2(6000), log2(24000), log2(96000)),
                     label = function(x) prettyNum(2^x, big.mark = ",", scientific = FALSE))
```

Better! Now we can define the groupings. Some sensible definitions would be that "big" countries are those with 100 million people and above, while "rich" countries are those with GDP per capita of $30,000 and above. Let's color the dots according to these groupings.

```{r}
df <- df %>%
  mutate(big = ifelse(pop > 10^8, "big", "small"),
         rich = ifelse(gpc > 30000, "rich", "poor")) %>%
  unite(col = "group", big:rich, sep = " and ")

ggplot(df, aes(x = log10(pop), y = log2(gpc), color = group)) +
  geom_point() + 
  scale_x_continuous(name = "Population",
                     breaks = c(log10(10^4), log10(10^5), log10(10^6), log10(10^7), log10(10^8), log10(10^9)),
                     label = c("10,000", "100,000", "1 million", "10 million", "100 million", "1 billion")) +
  scale_y_continuous(name = "GDP per capita constant 2015 US$",
                     breaks = c(log2(500), log2(1500), log2(10000), log2(30000)),
                     label = function(x) prettyNum(2^x, big.mark = ",", scientific = FALSE))
```

And here's the interesting result. Under this set of definitions, there are really only two big and rich countries: the United States and Japan. The biggest small and rich country is Germany, with a population of 82 million, while the richest small and poor country is Mexico, with a GDP per capita of $9,600. In short, no country in the near future is expected to join the big-and-rich club.

Not that this should be taken too seriously. Some would say 81 million people would make you a pretty big country. There are also some PPP-flavored quibbles to be made about GDP per capita.

Anyway, let's work on glamming up the chart. Let's remove the unnecessary elements and fix the colors. 

```{r}
ggplot(df, aes(x = log10(pop), y = log2(gpc), color = group)) +
  geom_point(size = 1) + 
  scale_color_manual(labels = c("Big and poor", "Big and rich", "Small and poor", "Small and rich"),
                     values = c("#E9532B", "#007db7", "#00A5D2", "#FDB415")) + 
  scale_x_continuous(name = "Population",
                     breaks = c(log10(10^4), log10(10^5), log10(10^6), log10(10^7), log10(10^8), log10(10^9)),
                     label = c("10,000", "100,000", "1 million", "10 million", "100 million", "1 billion")) +
  scale_y_continuous(name = "GDP per capita constant 2015 US$",
                     breaks = c(log2(500), log2(1500), log2(10000), log2(30000)),
                     label = function(x) prettyNum(2^x, big.mark = ",", scientific = FALSE))
```






