<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-03-22">

<title>Two Points Make a Line - I just read 456 books*</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../..//images/logo-icon.png" rel="icon" type="image/png">
<script src="../../site_libs/cookie-consent/cookie-consent.js"></script>
<link href="../../site_libs/cookie-consent/cookie-consent.css" rel="stylesheet">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-EJMC44PZ56"></script>

<script type="text/plain" cookie-consent="tracking">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-EJMC44PZ56', { 'anonymize_ip': true});
</script>

<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({
  "notice_banner_type":"simple",
  "consent_type":"implied",
  "palette":"light",
  "language":"en",
  "page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],
  "notice_banner_reject_button_hide":false,
  "preferences_center_close_button_hide":false,
  "website_name":""
  });
});
</script> 
  
<script type="module" src="../../site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="../../site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">


<meta property="og:title" content="Two Points Make a Line - I just read 456 books*">
<meta property="og:description" content="*Actually my computer did, but let's not split hairs. An exploration into NLP, dimensionality reduction, and reactive visualizations.">
<meta property="og:image" content="https://twopoints.blog/posts/2023-03-22-literary-analysis/thumbnail.png">
<meta property="og:site-name" content="Two Points Make a Line">
<meta property="og:image:height" content="1120">
<meta property="og:image:width" content="1843">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../images/logo-icon-invert.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Two Points Make a Line</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="dropdown-header">
 <span class="menu-text">Telling stories through visualized data — by Kenneth S. Reyes</span></li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../subscribe.html">
 <span class="menu-text">Subscribe</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/ksreyes/twopoints"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"><i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">I just read 456 books*</h1>
<p class="subtitle lead">*Actually my computer did, but let’s not split hairs. An exploration into NLP, dimensionality reduction, and reactive visualizations.</p>
  <div class="quarto-categories">
    <div class="quarto-category">network</div>
    <div class="quarto-category">scatter</div>
    <div class="quarto-category">interactive</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 22, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>In a <a href="https://twopoints.blog/posts/2022-11-19-the-emotional-shape-of-novels/">previous post</a>, we charted the emotional shape of three novels by assigning them sentiment scores through the <a href="https://search.r-project.org/CRAN/refmans/corpus/html/sentiment_afinn.html">AFINN lexicon</a>. But three is peanuts — I’m bolder now, more <em>audacious</em>, and subsisting on three cups of coffee a day. In this post, I chew on as many classics from the 19th century as my laptop will let me. The result is this beautiful visualization mapping the textual similarities between literary works, powered by <a href="https://www.d3indepth.com/force-layout/">D3’s force layout simulator</a>. Hover over a node to see the title and author, or click and drag to examine how each is connected to the rest.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1" data-startfrom="31" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 30;"><span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>library_network <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">'../../datasets/literary/library_network.json'</span>)<span class="op">.</span><span class="fu">json</span>({<span class="dt">typed</span><span class="op">:</span> <span class="kw">true</span>})</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="fu">addTooltips</span>(</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ForceGraph</span>(</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    library_network<span class="op">,</span> </span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>      <span class="dt">nodeId</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">id</span><span class="op">,</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>      <span class="dt">nodeGroup</span><span class="op">:</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">nationality</span><span class="op">,</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">nodeTitle</span><span class="op">:</span> d <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="op">.</span><span class="at">title</span><span class="sc">}\n${</span>d<span class="op">.</span><span class="at">query</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>d<span class="op">.</span><span class="at">nationality</span><span class="sc">}</span><span class="vs">)`</span><span class="op">,</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">nodeStrokeOpacity</span><span class="op">:</span> <span class="op">.</span><span class="dv">7</span><span class="op">,</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">linkStrokeWidth</span><span class="op">:</span> l <span class="kw">=&gt;</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">sqrt</span>(l<span class="op">.</span><span class="at">value</span>)<span class="op">,</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">nodeRadius</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">width</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span> <span class="dt">height</span><span class="op">:</span> <span class="dv">750</span><span class="op">,</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>      <span class="dt">colors</span><span class="op">:</span> [<span class="st">"#B13D70"</span><span class="op">,</span> <span class="st">"#7fc6a4"</span><span class="op">,</span> <span class="st">"#4889ab"</span><span class="op">,</span> <span class="st">"#F7DD72"</span>]</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  )<span class="op">,</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">r</span><span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="dt">opacity</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="st">"stroke-width"</span><span class="op">:</span> <span class="st">"2px"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span>}</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>Let’s see how we got here. To take advantage of certain packages, I’ll be using Python instead of my usual R.</p>
<div class="cell">
<details>
<summary>Packages</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-overflow-wrap code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard packages</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial.distance <span class="im">import</span> pdist</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co"># collections in Python &gt;3.9 no longer has MutableSet module so we have to get it from collections.abc for the cache download to work</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> collections</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections.abc <span class="im">import</span> MutableSet</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>collections.MutableSet <span class="op">=</span> collections.abc.MutableSet</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Text analysis</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> gutenbergpy.gutenbergcache <span class="im">import</span> GutenbergCache, GutenbergCacheSettings</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> gutenbergpy.textget</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.feature_extraction.text <span class="im">import</span> CountVectorizer</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics.pairwise <span class="im">import</span> cosine_similarity</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> textblob <span class="im">import</span> TextBlob</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> umap.umap_ <span class="im">as</span> umap</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As before, our data source is Project Gutenberg, accessed via the <a href="https://github.com/raduangelescu/gutenbergpy"><code>gutenbergpy</code></a> package. Downloading a work requires knowing its Gutenberg ID, which is tedious to look up if we want a ton of novels. Let’s devise a process that automatically fetches IDs given an author prompt — say, “Herman Melville”. To be able to search through the Gutenberg database, we must first generate a local cache of its records by running <code>GutenbergCache.create()</code>. This only needs to be done once. Once set up, we can connect to it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>connection <span class="op">=</span> sqlite3.<span class="ex">connect</span>(GutenbergCacheSettings.CACHE_FILENAME)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our SQL query will be of the following form:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode sql code-with-copy"><code class="sourceCode sql"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">SELECT</span> <span class="kw">DISTINCT</span> books.gutenbergbookid, authors.name, titles.name, books.numdownloads</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> books, authors, book_authors, titles</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">WHERE</span> authors.<span class="kw">id</span> <span class="op">=</span> book_authors.authorid</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> books.<span class="kw">id</span> <span class="op">=</span> book_authors.bookid</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> books.<span class="kw">id</span> <span class="op">=</span> titles.bookid</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> books.languageid <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> books.typeid <span class="op">=</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> authors.name <span class="kw">LIKE</span> <span class="st">'%Herman%'</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">AND</span> authors.name <span class="kw">LIKE</span> <span class="st">'%Melville%'</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">ORDER</span> <span class="kw">BY</span> books.numdownloads <span class="kw">DESC</span> </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="kw">LIMIT</span> <span class="dv">50</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Gutenberg is not a very clean library; much detritus is uploaded alongside the novels we actually want. To help focus the search, we order the query results by number of downloads and take at most the top 50. This removes some nuisance hits but, as we will see, there is much further work to be done.</p>
<p>Let’s write a function that generates a SQL query given an author prompt:</p>
<div class="cell">
<details>
<summary>query_author()</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> query_author(name):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  inputs <span class="op">=</span> name.split()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  query <span class="op">=</span> (</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SELECT DISTINCT books.gutenbergbookid, authors.name, titles.name, books.numdownloads '</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FROM books, authors, book_authors, titles '</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'WHERE authors.id = book_authors.authorid '</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>          <span class="st">'AND books.id = book_authors.bookid '</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">'AND books.id = titles.bookid '</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">'AND books.languageid = 1 '</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">'AND books.typeid = -1 '</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>      <span class="st">'AND </span><span class="sc">%s</span><span class="st"> '</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ORDER BY books.numdownloads DESC '</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'LIMIT 50'</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">%</span> <span class="st">' AND '</span>.join([<span class="st">"authors.name LIKE ('%"</span> <span class="op">+</span> <span class="st">"</span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span>n <span class="op">+</span> <span class="st">"%')"</span> <span class="cf">for</span> n <span class="kw">in</span> inputs])        </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> query</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Querying “Herman Melville” produces:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> pd.read_sql_query(query_author(<span class="st">'Herman Melville'</span>), connection)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>results.columns <span class="op">=</span> [<span class="st">'gutid'</span>, <span class="st">'author'</span>, <span class="st">'title'</span>, <span class="st">'downloads'</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results.head().to_markdown())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>|    |   gutid | author            | title                                           |   downloads |
|---:|--------:|:------------------|:------------------------------------------------|------------:|
|  0 |    2701 | Melville, Hermann | Moby Dick; Or, The Whale                        |      148386 |
|  1 |    2701 | Melville, Herman  | Moby Dick; Or, The Whale                        |      148386 |
|  2 |   11231 | Melville, Hermann | Bartleby, the Scrivener: A Story of Wall-Street |        2466 |
|  3 |   11231 | Melville, Herman  | Bartleby, the Scrivener: A Story of Wall-Street |        2466 |
|  4 |   15859 | Melville, Hermann | The Piazza Tales                                |        1186 |</code></pre>
</div>
</div>
<p>It is clear that duplicates are a problem. The multiple spellings of Melville’s name aren’t much of an issue since they map to the same Gutenberg IDs. We can easily remove these.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>duplicated_ids <span class="op">=</span> results[<span class="st">'gutid'</span>].duplicated(keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> results.loc[<span class="op">~</span>duplicated_ids].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results.to_markdown())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>|    |   gutid | author            | title                                                                                             |   downloads |
|---:|--------:|:------------------|:--------------------------------------------------------------------------------------------------|------------:|
|  0 |    2701 | Melville, Hermann | Moby Dick; Or, The Whale                                                                          |      148386 |
|  1 |   11231 | Melville, Hermann | Bartleby, the Scrivener: A Story of Wall-Street                                                   |        2466 |
|  2 |   15859 | Melville, Hermann | The Piazza Tales                                                                                  |        1186 |
|  3 |      15 | Melville, Hermann | Moby-Dick; or, The Whale                                                                          |        1137 |
|  4 |   21816 | Melville, Hermann | The Confidence-Man: His Masquerade                                                                |         432 |
|  5 |    1900 | Melville, Hermann | Typee: A Romance of the South Seas                                                                |         424 |
|  6 |   12384 | Melville, Hermann | Battle-Pieces and Aspects of the War                                                              |         283 |
|  7 |   34970 | Melville, Hermann | Pierre; or The Ambiguities                                                                        |         280 |
|  8 |   28656 | Melville, Hermann | Typee                                                                                             |         216 |
|  9 |    2489 | Melville, Hermann | Moby Dick; Or, The Whale                                                                          |         185 |
| 10 |   10712 | Melville, Hermann | White Jacket; Or, The World on a Man-of-War                                                       |         180 |
| 11 |    8118 | Melville, Hermann | Redburn. His First Voyage                                                                         |         160 |
|    |         |                   | Being the Sailor Boy Confessions and Reminiscences of the Son-Of-A-Gentleman in the Merchant Navy |             |
| 12 |    4045 | Melville, Hermann | Omoo: Adventures in the South Seas                                                                |         148 |
| 13 |   53861 | Melville, Hermann | The Apple-Tree Table, and Other Sketches                                                          |         140 |
| 14 |    2694 | Melville, Hermann | I and My Chimney                                                                                  |         137 |
| 15 |   13720 | Melville, Hermann | Mardi: and A Voyage Thither, Vol. I                                                               |          97 |
| 16 |   15422 | Melville, Hermann | Israel Potter: His Fifty Years of Exile                                                           |          69 |
| 17 |   13721 | Melville, Hermann | Mardi: and A Voyage Thither, Vol. II                                                              |          51 |
| 18 |   12841 | Melville, Hermann | John Marr and Other Poems                                                                         |          51 |
| 19 |   58477 | Melville, Hermann | Index of the Project Gutenberg Works of Herman Melville                                           |          40 |</code></pre>
</div>
</div>
<p>More problematically, title variants of the same work (“Moby Dick; Or, The Whale” vs “Moby Dick; or, The Whale”) map to <em>different</em> IDs. To handle these, we compute a measure for how similar two titles are based on how many case-insensitive, non-trivial words they share. Counting only non-trivial words means that the presence of “or the” in both “Moby Dick; Or, The Whale” and “Pierre; or The Ambiguities” should <em>not</em> count towards their similarity.</p>
<p>The measure we use is <a href="https://en.wikipedia.org/wiki/Cosine_similarity">cosine similarity</a>. Computing this pairwise for all titles produces a matrix, the upper triangular half of which we chop off since we want to prioritize removing duplicates with the lower number of downloads. Let’s demonstrate with the “Herman Melville” query results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute cosine similarity matrix</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>results_vectorized <span class="op">=</span> CountVectorizer(stop_words<span class="op">=</span><span class="st">"english"</span>).fit_transform(<span class="bu">list</span>(results[<span class="st">'title'</span>]))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>cosine_sim <span class="op">=</span> cosine_similarity(results_vectorized)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>cosine_sim[np.triu_indices_from(cosine_sim)] <span class="op">=</span> np.nan</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Print</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(linewidth<span class="op">=</span>np.inf)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>cosine_sim <span class="op">=</span> np.<span class="bu">round</span>(cosine_sim, decimals<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>cosine_sim</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([[ nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [1.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.5 , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [1.  , 0.  , 0.  , 1.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.26, 0.  , 0.22, 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.5 , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.16, 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.14, 0.  , 0.  , 0.  , 0.89, 0.  ,  nan,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan,  nan],
       [0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  , 0.  ,  nan]])</code></pre>
</div>
</div>
<p>We can use some threshold — say, 0.5 — to select the indices of potential duplicates and remove them. Note that this method isn’t perfect: column 5 (“Typee: A Romance of the South Seas”), for instance, has similarity scores of 0.5 with both row 8 (“Typee”) and row 12 (“Omoo: Adventures in the South Seas”). <em>Typee</em> and <em>Omoo</em> are two different novels that share similar subtitles, so unfortunately our approach inadvertently removes <em>Omoo</em>.</p>
<p>Let’s turn all this into a function and apply it to the “Herman Melville” results.</p>
<div class="cell">
<details>
<summary>remove_duplicates()</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> remove_duplicates(df):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove duplicates by Gutenberg book ID</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  duplicated_ids <span class="op">=</span> df[<span class="st">'gutid'</span>].duplicated(keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> df.loc[<span class="op">~</span>duplicated_ids].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract similar titles</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  vectorized <span class="op">=</span> CountVectorizer(stop_words<span class="op">=</span><span class="st">'english'</span>).fit_transform(<span class="bu">list</span>(df[<span class="st">'title'</span>]))</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  cosine_sim <span class="op">=</span> cosine_similarity(vectorized)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  cosine_sim[np.triu_indices_from(cosine_sim)] <span class="op">=</span> np.nan</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  indices <span class="op">=</span> []</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i, row <span class="kw">in</span> <span class="bu">enumerate</span>(cosine_sim):</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">any</span>(<span class="kw">not</span> np.isnan(x) <span class="kw">and</span> x <span class="op">&gt;=</span> <span class="fl">0.5</span> <span class="cf">for</span> x <span class="kw">in</span> row):</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>      indices.append(i)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># But keep parts of a series</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  indices_keep <span class="op">=</span> np.where(df[<span class="st">'title'</span>].<span class="bu">str</span>.contains(pat<span class="op">=</span><span class="st">'Vol|vol|Part|part'</span>))[<span class="dv">0</span>]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  indices <span class="op">=</span> [i <span class="cf">for</span> i <span class="kw">in</span> indices <span class="cf">if</span> i <span class="kw">not</span> <span class="kw">in</span> indices_keep]</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> df.drop(indices).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>results_cleaned <span class="op">=</span> remove_duplicates(results)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_cleaned.to_markdown())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>|    |   gutid | author            | title                                                                                             |   downloads |
|---:|--------:|:------------------|:--------------------------------------------------------------------------------------------------|------------:|
|  0 |    2701 | Melville, Hermann | Moby Dick; Or, The Whale                                                                          |      148386 |
|  1 |   11231 | Melville, Hermann | Bartleby, the Scrivener: A Story of Wall-Street                                                   |        2466 |
|  2 |   15859 | Melville, Hermann | The Piazza Tales                                                                                  |        1186 |
|  3 |   21816 | Melville, Hermann | The Confidence-Man: His Masquerade                                                                |         432 |
|  4 |    1900 | Melville, Hermann | Typee: A Romance of the South Seas                                                                |         424 |
|  5 |   12384 | Melville, Hermann | Battle-Pieces and Aspects of the War                                                              |         283 |
|  6 |   34970 | Melville, Hermann | Pierre; or The Ambiguities                                                                        |         280 |
|  7 |   10712 | Melville, Hermann | White Jacket; Or, The World on a Man-of-War                                                       |         180 |
|  8 |    8118 | Melville, Hermann | Redburn. His First Voyage                                                                         |         160 |
|    |         |                   | Being the Sailor Boy Confessions and Reminiscences of the Son-Of-A-Gentleman in the Merchant Navy |             |
|  9 |   53861 | Melville, Hermann | The Apple-Tree Table, and Other Sketches                                                          |         140 |
| 10 |    2694 | Melville, Hermann | I and My Chimney                                                                                  |         137 |
| 11 |   13720 | Melville, Hermann | Mardi: and A Voyage Thither, Vol. I                                                               |          97 |
| 12 |   15422 | Melville, Hermann | Israel Potter: His Fifty Years of Exile                                                           |          69 |
| 13 |   13721 | Melville, Hermann | Mardi: and A Voyage Thither, Vol. II                                                              |          51 |
| 14 |   12841 | Melville, Hermann | John Marr and Other Poems                                                                         |          51 |
| 15 |   58477 | Melville, Hermann | Index of the Project Gutenberg Works of Herman Melville                                           |          40 |</code></pre>
</div>
</div>
<p>The list of authors whose works we will analyze is given under the fold. I’ve selected those who were most representative of English, American, French, and Russian literature during the 19th century. This list, of course, is subjective. We will be using English translations of the non-English works.</p>
<div class="cell">
<details>
<summary>Authors list</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>authors <span class="op">=</span> {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'English'</span>: [</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Walter Scott'</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Jane Austen'</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mary Shelley'</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'William Thackeray'</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Charles Dickens'</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Charlotte Bronte'</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Emily Bronte'</span>,</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'George Eliot'</span>,</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Anthony Trollope'</span>,</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Thomas Hardy'</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  ], </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">'American'</span>: [</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Louisa May Alcott'</span>,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Nathaniel Hawthorne'</span>,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Herman Melville'</span>,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Mark Twain'</span>,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Henry James'</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  ], </span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">'French'</span>: [</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Stendhal'</span>,</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Alexander Dumas'</span>,</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Victor Hugo'</span>,</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Gustave Flaubert'</span>,</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Honore de Balzac'</span>,</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Emile Zola'</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>  ], </span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Russian'</span>: [</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Nikolai Gogol'</span>,</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Ivan Turgenev'</span>,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Fyodor Dostoevsky'</span>,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Leo Tolstoy'</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This loop assembles our library of IDs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>library <span class="op">=</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">'gutid'</span>, <span class="st">'author'</span>, <span class="st">'title'</span>, <span class="st">'downloads'</span>, <span class="st">'nationality'</span>])</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> nationality, names <span class="kw">in</span> authors.items():</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> name <span class="kw">in</span> names:</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> pd.read_sql_query(query_author(name), connection)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    results.columns <span class="op">=</span> [<span class="st">'gutid'</span>, <span class="st">'author'</span>, <span class="st">'title'</span>, <span class="st">'downloads'</span>]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> remove_duplicates(results)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'query'</span>] <span class="op">=</span> name</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'nationality'</span>] <span class="op">=</span> nationality</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    library <span class="op">=</span> pd.concat([library, results], ignore_index<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Scanning the result, I see that there’s a bunch more included that shouldn’t have been. I just remove these manually under the fold.</p>
<div class="cell">
<details>
<summary>Further adjustments</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>exclude_authors <span class="op">=</span> [</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Herr, Charlotte Bronte'</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Stark, James Henry'</span>, </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Schmitz, James Henry'</span>, </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Maine, Henry James Sumner, Sir'</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>exclude_titles <span class="op">=</span> [</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Gutenberg'</span>, </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Poems</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Poems'</span>, </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Ballads'</span>, </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Lyrics'</span>, </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Verses'</span>, </span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Marmion: A Tale Of Flodden Field'</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">'The Lady of the Lake'</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">'The Mahogany Tree'</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Richard Coeur de Lion and Blondel'</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">'The Loving Ballad of Lord Bateman'</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Biographical</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Letters'</span>, </span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Speeches'</span>,</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">'literary and scientific men'</span>, </span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Biographical Notes'</span>, </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">'My Memoirs'</span>, </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">'The Memoirs of Victor Hugo'</span>, </span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">'An Autobiography of Anthony Trollope'</span>, </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">'The trial of Emile Zola'</span>,</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">'The George Sand-Gustave Flaubert Letters'</span>, </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Duplicates</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Les Misérables, v. 1/5: Fantine'</span>, </span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">'The Grand Inquisitor'</span>, </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Fathers and Children'</span>,</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">'The Charterhouse of Parma, Volume'</span>, </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Madame Bovary: A Tale of Provincial Life'</span>,</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">'Home Life in Russia, Volumes 1 and 2'</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>library <span class="op">=</span> library.loc[<span class="op">~</span>library[<span class="st">'author'</span>].<span class="bu">str</span>.contains(<span class="st">'|'</span>.join(exclude_authors))].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>library <span class="op">=</span> library.loc[<span class="op">~</span>library[<span class="st">'title'</span>].<span class="bu">str</span>.contains(<span class="st">'|'</span>.join(exclude_titles))].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The resulting library contains 456 unique IDs of what <em>I hope</em> are mostly novels, short story collections, and works of creative non-fiction. I have tried to exclude all poetry, plays, and any remaining duplicates.</p>
<p>Armed with these IDs, we get the actual texts from Gutenberg and perform a little cleaning on them using the function <code>get_and_clean_text()</code>.</p>
<div class="cell">
<details>
<summary>get_and_clean_text()</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_and_clean_text(<span class="bu">id</span>):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get text</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  raw_text <span class="op">=</span> gutenbergpy.textget.get_text_by_id(<span class="bu">id</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  text <span class="op">=</span> gutenbergpy.textget.strip_headers(raw_text).decode()</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove page-based line breaks and excessive paragraph breaks</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  text <span class="op">=</span> re.sub(<span class="st">'(?&lt;=[^</span><span class="ch">\n</span><span class="st">])</span><span class="ch">\n</span><span class="sc">{1}</span><span class="st">(?=[^</span><span class="ch">\n</span><span class="st">])'</span>, <span class="st">' '</span>, text)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>  text <span class="op">=</span> re.sub(<span class="st">'[</span><span class="ch">\n</span><span class="st">]{3,}'</span>, <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>, text)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Go paragraph by paragraph</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> pd.DataFrame({<span class="st">'paragraph'</span>: text.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)})</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  patterns <span class="op">=</span> [</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'^$'</span>,                   <span class="co"># Empty</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'^[A-Z\s\W\d]+$'</span>,       <span class="co"># Contains only uppercase letters (likely a heading)</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'^Chapter'</span>,             <span class="co"># Starts with "Chapter"</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'^CHAPTER'</span>,             <span class="co"># Starts with "Chapter"</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'^\s+Chapter'</span>,          <span class="co"># Starts with "Chapter"</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'^[A-Za-z]+$'</span>,          <span class="co"># Contains just one word, no punctuation</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Gutenberg'</span>, <span class="st">'Illustration'</span>, <span class="st">'Online Distributed Proofreading Team'</span>, <span class="st">'.jpg'</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> df.loc[<span class="op">~</span>df[<span class="st">'paragraph'</span>].<span class="bu">str</span>.contains(pat<span class="op">=</span><span class="st">'|'</span>.join(patterns), regex<span class="op">=</span><span class="va">True</span>)]</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  clean_text <span class="op">=</span> <span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>.join(<span class="bu">list</span>(df[<span class="st">'paragraph'</span>]))</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> clean_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>texts <span class="op">=</span> []</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(library)):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  text <span class="op">=</span> get_and_clean_text(library[<span class="st">'gutid'</span>][row])</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  texts.append(text)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>library[<span class="st">'text'</span>] <span class="op">=</span> texts</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>connection.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are ready to compute some metrics on our texts. It’s easy enough to get word counts, which is useful for validating whether our library has excluded poems and plays. The <a href="https://textblob.readthedocs.io/en/dev/index.html"><code>textblob</code></a> package also has a sentiment analyzer that we can use; this ranges from -1 to 1. Another interesting metric to look at is the average word count per paragraph, which captures a bit of the author’s style: short and punchy or long and meditative.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>library_stats <span class="op">=</span> library[[<span class="st">'nationality'</span>, <span class="st">'query'</span>, <span class="st">'title'</span>]].copy()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Word count, sentiment, and subjectivity</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>library_stats[<span class="st">'words'</span>] <span class="op">=</span> library[<span class="st">'text'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> n: <span class="bu">len</span>(n.split()))</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>library_stats[<span class="st">'sentiment'</span>] <span class="op">=</span> library[<span class="st">'text'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> n: TextBlob(n).polarity)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Average paragraph length</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parlength(text):</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  df <span class="op">=</span> pd.DataFrame({<span class="st">'paragraph'</span>: text.split(<span class="st">'</span><span class="ch">\n\n</span><span class="st">'</span>)})</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  df[<span class="st">'words'</span>] <span class="op">=</span> df[<span class="st">'paragraph'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> n: <span class="bu">len</span>(re.split(<span class="vs">r' |—'</span>, n)))</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> df[<span class="st">'words'</span>].mean()</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>library_stats[<span class="st">'parlength'</span>] <span class="op">=</span> library[<span class="st">'text'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> n: parlength(n))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A more sophisticated metric is the extent to which works are textually akin to one another. We already did something similar to detect title duplicates in the Gutenberg database. However, amassing pairwise similarity scores across all our texts will result in far too much information to comprehend. What we will therefore do is apply a dimensionality reduction algorithm to simplify the large number of features into just two — call them <em>x</em> and <em>y</em>. These are meaningless in themselves, but if plotted on a plane, they approximate the multidimensional structure of the dataset in 2D space. The particular algorithm we use is <a href="https://arxiv.org/abs/1802.03426">UMAP</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>library_vec <span class="op">=</span> CountVectorizer(min_df<span class="op">=</span><span class="dv">5</span>, stop_words<span class="op">=</span><span class="st">'english'</span>).fit_transform(library[<span class="st">'text'</span>])</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>embeddings <span class="op">=</span> umap.UMAP(random_state<span class="op">=</span><span class="dv">42</span>).fit_transform(library_vec)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>library_stats[<span class="st">"x"</span>] <span class="op">=</span> embeddings[:,<span class="dv">0</span>]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>library_stats[<span class="st">"y"</span>] <span class="op">=</span> embeddings[:,<span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>A technical aside: at this point, I save my results in a csv file and work off that from here on out. This ensures reproducibility should any changes occur in Project Gutenberg.</p>
<p>Now let’s load up our dataset again, this time in OJS for our visualizations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" data-startfrom="397" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 396;"><span id="cb22-397"><a href="#cb22-397" aria-hidden="true" tabindex="-1"></a>library_stats <span class="op">=</span> <span class="fu">FileAttachment</span>(<span class="st">'../../datasets/literary/library_stats.csv'</span>)<span class="op">.</span><span class="fu">csv</span>({<span class="dt">typed</span><span class="op">:</span> <span class="kw">true</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="ojs-cell-2" data-nodetype="declaration">

</div>
</div>
</div>
<p>The scatter below charts literary works on two axes: average paragraph length and sentiment. You can select a particular author from the dropdown box to highlight their works. Because latter-career Henry James forgot how to end paragraphs (and <a href="https://jonreeve.com/2017/06/henry-james-sentence/">sentences</a>), I have had to add a slider for expanding the horizontal axis.</p>
<div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23" data-startfrom="408" data-source-offset="-1"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 407;"><span id="cb23-408"><a href="#cb23-408" aria-hidden="true" tabindex="-1"></a>viewof highlight_a <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(</span>
<span id="cb23-409"><a href="#cb23-409" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">group</span>(library_stats<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">query</span>)<span class="op">,</span> </span>
<span id="cb23-410"><a href="#cb23-410" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">label</span><span class="op">:</span> <span class="fu">html</span><span class="vs">`&lt;b&gt;Highlight an author&lt;/b&gt;`</span><span class="op">,</span> <span class="dt">key</span><span class="op">:</span> <span class="st">"Herman Melville"</span>}</span>
<span id="cb23-411"><a href="#cb23-411" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-412"><a href="#cb23-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-413"><a href="#cb23-413" aria-hidden="true" tabindex="-1"></a>viewof parlength_max <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb23-414"><a href="#cb23-414" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">100</span><span class="op">,</span> <span class="dv">650</span>]<span class="op">,</span> </span>
<span id="cb23-415"><a href="#cb23-415" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">label</span><span class="op">:</span> <span class="fu">html</span><span class="vs">`&lt;b&gt;Paragraph length&lt;/b&gt;`</span><span class="op">,</span> <span class="dt">value</span><span class="op">:</span> <span class="dv">200</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="dv">1</span>}</span>
<span id="cb23-416"><a href="#cb23-416" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-417"><a href="#cb23-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-418"><a href="#cb23-418" aria-hidden="true" tabindex="-1"></a><span class="fu">addTooltips</span>(</span>
<span id="cb23-419"><a href="#cb23-419" aria-hidden="true" tabindex="-1"></a>  Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb23-420"><a href="#cb23-420" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb23-421"><a href="#cb23-421" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">frame</span>({<span class="dt">fill</span><span class="op">:</span> <span class="st">"#f7f7f7"</span>})<span class="op">,</span></span>
<span id="cb23-422"><a href="#cb23-422" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>(</span>
<span id="cb23-423"><a href="#cb23-423" aria-hidden="true" tabindex="-1"></a>        library_stats<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">parlength</span> <span class="op">&lt;</span> parlength_max)<span class="op">,</span> </span>
<span id="cb23-424"><a href="#cb23-424" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb23-425"><a href="#cb23-425" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"parlength"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"sentiment"</span><span class="op">,</span> </span>
<span id="cb23-426"><a href="#cb23-426" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">fill</span><span class="op">:</span> <span class="st">"nationality"</span><span class="op">,</span> <span class="dt">fillOpacity</span><span class="op">:</span> <span class="fl">0.75</span><span class="op">,</span> </span>
<span id="cb23-427"><a href="#cb23-427" aria-hidden="true" tabindex="-1"></a>          <span class="dt">stroke</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">strokeOpacity</span><span class="op">:</span> <span class="op">.</span><span class="dv">7</span><span class="op">,</span></span>
<span id="cb23-428"><a href="#cb23-428" aria-hidden="true" tabindex="-1"></a>          <span class="dt">title</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="op">.</span><span class="at">title</span><span class="sc">}\n${</span>d<span class="op">.</span><span class="at">query</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>d<span class="op">.</span><span class="at">nationality</span><span class="sc">}</span><span class="vs">)`</span></span>
<span id="cb23-429"><a href="#cb23-429" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb23-430"><a href="#cb23-430" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>(</span>
<span id="cb23-431"><a href="#cb23-431" aria-hidden="true" tabindex="-1"></a>        highlight_a<span class="op">.</span><span class="fu">filter</span>(d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">parlength</span> <span class="op">&lt;</span> parlength_max)<span class="op">,</span> </span>
<span id="cb23-432"><a href="#cb23-432" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb23-433"><a href="#cb23-433" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"parlength"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"sentiment"</span><span class="op">,</span> </span>
<span id="cb23-434"><a href="#cb23-434" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">3</span></span>
<span id="cb23-435"><a href="#cb23-435" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-436"><a href="#cb23-436" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb23-437"><a href="#cb23-437" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {</span>
<span id="cb23-438"><a href="#cb23-438" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Average paragraph wordcount"</span><span class="op">,</span></span>
<span id="cb23-439"><a href="#cb23-439" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelAnchor</span><span class="op">:</span> <span class="st">"center"</span><span class="op">,</span></span>
<span id="cb23-440"><a href="#cb23-440" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span> <span class="dt">tickSize</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">grid</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-441"><a href="#cb23-441" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> [d3<span class="op">.</span><span class="fu">min</span>(library_stats<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">parlength</span>)<span class="op">,</span> parlength_max]</span>
<span id="cb23-442"><a href="#cb23-442" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb23-443"><a href="#cb23-443" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {</span>
<span id="cb23-444"><a href="#cb23-444" aria-hidden="true" tabindex="-1"></a>      <span class="dt">label</span><span class="op">:</span> <span class="st">"Sentiment"</span><span class="op">,</span></span>
<span id="cb23-445"><a href="#cb23-445" aria-hidden="true" tabindex="-1"></a>      <span class="dt">labelAnchor</span><span class="op">:</span> <span class="st">"center"</span><span class="op">,</span></span>
<span id="cb23-446"><a href="#cb23-446" aria-hidden="true" tabindex="-1"></a>      <span class="dt">ticks</span><span class="op">:</span> <span class="dv">5</span><span class="op">,</span> <span class="dt">tickSize</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">grid</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb23-447"><a href="#cb23-447" aria-hidden="true" tabindex="-1"></a>      <span class="dt">domain</span><span class="op">:</span> d3<span class="op">.</span><span class="fu">extent</span>(library_stats<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">sentiment</span>)</span>
<span id="cb23-448"><a href="#cb23-448" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb23-449"><a href="#cb23-449" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> { </span>
<span id="cb23-450"><a href="#cb23-450" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> </span>
<span id="cb23-451"><a href="#cb23-451" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#B13D70"</span><span class="op">,</span> <span class="st">"#7fc6a4"</span><span class="op">,</span> <span class="st">"#4889ab"</span><span class="op">,</span> <span class="st">"#F7DD72"</span>]<span class="op">,</span></span>
<span id="cb23-452"><a href="#cb23-452" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb23-453"><a href="#cb23-453" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span> <span class="dt">height</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb23-454"><a href="#cb23-454" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">15</span><span class="op">,</span> <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">45</span><span class="op">,</span> <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">65</span><span class="op">,</span> </span>
<span id="cb23-455"><a href="#cb23-455" aria-hidden="true" tabindex="-1"></a>    <span class="dt">insetTop</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">insetRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">insetBottom</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">insetLeft</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb23-456"><a href="#cb23-456" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb23-457"><a href="#cb23-457" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">r</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">opacity</span><span class="op">:</span> <span class="op">.</span><span class="dv">8</span><span class="op">,</span> <span class="st">"stroke-width"</span><span class="op">:</span> <span class="st">"3px"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span>}</span>
<span id="cb23-458"><a href="#cb23-458" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div>
<div id="ojs-cell-3-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<div>
<div id="ojs-cell-3-2" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="cell-output cell-output-display quarto-layout-cell" style="flex-basis: 100.0%;justify-content: center;">
<div>
<div id="ojs-cell-3-3" data-nodetype="expression">

</div>
</div>
</div>
</div>
</div>
</div>
<p>The shortest paragraphs are in the works of Alexandre Dumas, the 19th century’s Tom Clancy. Most (&gt;87%) of the works in the sample generally stick to paragraphs of 100 words or less. In terms of sentiment scores, I was amused to find that <em>Crime and Punishment</em> has a slightly more positive sentiment than <em>Wuthering Heights</em>. Go figure: one explores the utter depths of murderous, depraved, hopeless insanity; the other is <em>Crime and Punishment</em>.</p>
<p>The next chart uses the results of the UMAP dimension-reduction algorithm. Again, the values themselves are arbitrary but the positioning of the nodes in 2D space hints at the semantic relationships across texts. There is an interesting cluster comprising <em>Count of Monte Cristo</em>, <em>Les Misérables</em>, <em>War and Peace</em>, and <em>Anna Karenina</em>. These are the blue and yellow dots to the left, somewhat isolated from the other French and Russian works in the sample. Either these books are quite English in content or the particular translations here leaned heavily on English semantics.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24" data-startfrom="469" data-source-offset="-1"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 468;"><span id="cb24-469"><a href="#cb24-469" aria-hidden="true" tabindex="-1"></a>viewof highlight_b <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">select</span>(</span>
<span id="cb24-470"><a href="#cb24-470" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">group</span>(library_stats<span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">query</span>)<span class="op">,</span> </span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">label</span><span class="op">:</span> <span class="fu">html</span><span class="vs">`&lt;b&gt;Highlight an author&lt;/b&gt;`</span><span class="op">,</span> <span class="dt">key</span><span class="op">:</span> <span class="st">"Herman Melville"</span>}</span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a><span class="fu">addTooltips</span>(</span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a>  Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">frame</span>({<span class="dt">fill</span><span class="op">:</span> <span class="st">"#f7f7f7"</span>})<span class="op">,</span></span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>(</span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a>        library_stats<span class="op">,</span> </span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span> </span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">fill</span><span class="op">:</span> <span class="st">"nationality"</span><span class="op">,</span> <span class="dt">fillOpacity</span><span class="op">:</span> <span class="fl">0.75</span><span class="op">,</span> </span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a>          <span class="dt">stroke</span><span class="op">:</span> <span class="st">"white"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">strokeOpacity</span><span class="op">:</span> <span class="op">.</span><span class="dv">7</span><span class="op">,</span></span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a>          <span class="dt">title</span><span class="op">:</span> (d) <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>d<span class="op">.</span><span class="at">title</span><span class="sc">}</span><span class="vs"> </span><span class="sc">\n</span><span class="vs"> </span><span class="sc">${</span>d<span class="op">.</span><span class="at">query</span><span class="sc">}</span><span class="vs"> (</span><span class="sc">${</span>d<span class="op">.</span><span class="at">nationality</span><span class="sc">}</span><span class="vs">)`</span></span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a>        })<span class="op">,</span></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a>      Plot<span class="op">.</span><span class="fu">dot</span>(</span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a>        highlight_b<span class="op">,</span> </span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a>          <span class="dt">x</span><span class="op">:</span> <span class="st">"x"</span><span class="op">,</span> <span class="dt">y</span><span class="op">:</span> <span class="st">"y"</span><span class="op">,</span> </span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a>          <span class="dt">r</span><span class="op">:</span> <span class="dv">7</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span><span class="op">,</span> <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">3</span></span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a>    ]<span class="op">,</span></span>
<span id="cb24-493"><a href="#cb24-493" aria-hidden="true" tabindex="-1"></a>    <span class="dt">x</span><span class="op">:</span> {<span class="dt">label</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span> <span class="dt">ticks</span><span class="op">:</span> <span class="dv">0</span>}<span class="op">,</span></span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a>    <span class="dt">y</span><span class="op">:</span> {<span class="dt">label</span><span class="op">:</span> <span class="kw">null</span><span class="op">,</span> <span class="dt">ticks</span><span class="op">:</span> <span class="dv">0</span>}<span class="op">,</span></span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a>    <span class="dt">color</span><span class="op">:</span> { </span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> </span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a>      <span class="dt">range</span><span class="op">:</span> [<span class="st">"#B13D70"</span><span class="op">,</span> <span class="st">"#7fc6a4"</span><span class="op">,</span> <span class="st">"#4889ab"</span><span class="op">,</span> <span class="st">"#F7DD72"</span>]<span class="op">,</span></span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a>    }<span class="op">,</span></span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a>    <span class="dt">width</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span> <span class="dt">height</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a>    <span class="dt">marginTop</span><span class="op">:</span> <span class="dv">15</span><span class="op">,</span> <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">marginLeft</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a>    <span class="dt">insetTop</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">insetRight</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">insetBottom</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span> <span class="dt">insetLeft</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">r</span><span class="op">:</span> <span class="dv">6</span><span class="op">,</span> <span class="dt">opacity</span><span class="op">:</span> <span class="op">.</span><span class="dv">8</span><span class="op">,</span> <span class="st">"stroke-width"</span><span class="op">:</span> <span class="st">"3px"</span><span class="op">,</span> <span class="dt">stroke</span><span class="op">:</span> <span class="st">"black"</span>}</span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-4-2" data-nodetype="expression">

</div>
</div>
</div>
</div>
<p>This scatter is all well and good, but a funner, more interactive way to represent these relationships is through a force-directed network chart, as shown at the top of this blog post. Note that a network chart generator finds the best node positionings given the strength of their linkages. UMAP, meanwhile, <em>starts</em> by defining node positions. To extract a network chart from our UMAP values, we therefore have to reverse engineer the node linkages from the node positions. The way I have done this is by computing the Euclidean distance between nodes and setting the inverse of that as their linkage strength. I then fed this to D3’s force-directed algorithm to produce the network chart above.</p>
<div class="cell">
<details>
<summary>Constructing a network dataset</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>pairs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">set</span>(itertools.combinations(library_stats.index.tolist(), <span class="dv">2</span>)))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>pairs.sort()</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>distances <span class="op">=</span> pdist(library_stats[[<span class="st">'x'</span>, <span class="st">'y'</span>]].values)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> <span class="bu">max</span>(distances) <span class="op">-</span> distances</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> pd.DataFrame(pairs, columns<span class="op">=</span>[<span class="st">'source'</span>, <span class="st">'target'</span>])</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>links[<span class="st">'value'</span>] <span class="op">=</span> values</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>links <span class="op">=</span> links[<span class="op">~</span>(links[<span class="st">'value'</span>] <span class="op">&lt;</span> <span class="fl">9.1</span>)]</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>links[<span class="st">'value'</span>] <span class="op">=</span> (links[<span class="st">'value'</span>]<span class="op">-</span>links[<span class="st">'value'</span>].<span class="bu">min</span>())<span class="op">*</span>(<span class="dv">5</span><span class="op">/</span>(links[<span class="st">'value'</span>].<span class="bu">max</span>()<span class="op">-</span>links[<span class="st">'value'</span>].<span class="bu">min</span>()))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>nodes <span class="op">=</span> pd.DataFrame({</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">'id'</span>: library_stats.index,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">'title'</span>: library_stats[<span class="st">'title'</span>],</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">'query'</span>: library_stats[<span class="st">'query'</span>],</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">'nationality'</span>: library_stats[<span class="st">'nationality'</span>]</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert dataframes to dictionaries, then to json</span></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>nodes_dict <span class="op">=</span> nodes.to_dict(orient<span class="op">=</span><span class="st">'records'</span>)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>links_dict <span class="op">=</span> links.to_dict(orient<span class="op">=</span><span class="st">'records'</span>)</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>network_dict <span class="op">=</span> {<span class="st">'nodes'</span>: nodes_dict, <span class="st">'links'</span>: links_dict}</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>network <span class="op">=</span> json.dumps(network_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>So we have analyzed 456 books. Can we go bolder still, more audacious still? The Gutenberg library is vast. Unfortunately, it’s also a mess. There have been many attempts to tame it, including <code>gutenbergpy</code>, but I’m still finding that the efforts involved in data cleaning and data wrangling scale faster than the marginal value of expanding the dataset further. I’ll have to wait for a better API. Until then, this has been your sign to get back to (or start!) the habit of reading. May I suggest <em>Moby-Dick</em>? <img src="../../images/logo-icon.png" class="endmark img-fluid"></p>
<br>
<hr>
<p><strong>Appendix: Observable JS functions</strong></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26" data-startfrom="544" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 543;"><span id="cb26-544"><a href="#cb26-544" aria-hidden="true" tabindex="-1"></a><span class="co">// Source: https://observablehq.com/@mkfreeman/plot-tooltip</span></span>
<span id="cb26-545"><a href="#cb26-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-546"><a href="#cb26-546" aria-hidden="true" tabindex="-1"></a>addTooltips <span class="op">=</span> (chart<span class="op">,</span> styles) <span class="kw">=&gt;</span> {</span>
<span id="cb26-547"><a href="#cb26-547" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> stroke_styles <span class="op">=</span> { <span class="dt">stroke</span><span class="op">:</span> <span class="st">"blue"</span><span class="op">,</span> <span class="st">"stroke-width"</span><span class="op">:</span> <span class="dv">3</span> }<span class="op">;</span></span>
<span id="cb26-548"><a href="#cb26-548" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> fill_styles <span class="op">=</span> { <span class="dt">fill</span><span class="op">:</span> <span class="st">"blue"</span><span class="op">,</span> <span class="dt">opacity</span><span class="op">:</span> <span class="fl">0.5</span> }<span class="op">;</span></span>
<span id="cb26-549"><a href="#cb26-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-550"><a href="#cb26-550" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Workaround if it's in a figure</span></span>
<span id="cb26-551"><a href="#cb26-551" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> type <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(chart)<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="at">tagName</span><span class="op">;</span></span>
<span id="cb26-552"><a href="#cb26-552" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> wrapper <span class="op">=</span></span>
<span id="cb26-553"><a href="#cb26-553" aria-hidden="true" tabindex="-1"></a>    type <span class="op">===</span> <span class="st">"FIGURE"</span> <span class="op">?</span> d3<span class="op">.</span><span class="fu">select</span>(chart)<span class="op">.</span><span class="fu">select</span>(<span class="st">"svg"</span>) <span class="op">:</span> d3<span class="op">.</span><span class="fu">select</span>(chart)<span class="op">;</span></span>
<span id="cb26-554"><a href="#cb26-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-555"><a href="#cb26-555" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Workaround if there's a legend....</span></span>
<span id="cb26-556"><a href="#cb26-556" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svgs <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(chart)<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"svg"</span>)<span class="op">;</span></span>
<span id="cb26-557"><a href="#cb26-557" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (svgs<span class="op">.</span><span class="fu">size</span>() <span class="op">&gt;</span> <span class="dv">1</span>) wrapper <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>([<span class="op">...</span>svgs]<span class="op">.</span><span class="fu">pop</span>())<span class="op">;</span></span>
<span id="cb26-558"><a href="#cb26-558" aria-hidden="true" tabindex="-1"></a>  wrapper<span class="op">.</span><span class="fu">style</span>(<span class="st">"overflow"</span><span class="op">,</span> <span class="st">"visible"</span>)<span class="op">;</span> <span class="co">// to avoid clipping at the edges</span></span>
<span id="cb26-559"><a href="#cb26-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-560"><a href="#cb26-560" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set pointer events to visibleStroke if the fill is none (e.g., if its a line)</span></span>
<span id="cb26-561"><a href="#cb26-561" aria-hidden="true" tabindex="-1"></a>  wrapper<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"path"</span>)<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span> (data<span class="op">,</span> index<span class="op">,</span> nodes) {</span>
<span id="cb26-562"><a href="#cb26-562" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For line charts, set the pointer events to be visible stroke</span></span>
<span id="cb26-563"><a href="#cb26-563" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (</span>
<span id="cb26-564"><a href="#cb26-564" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span>) <span class="op">===</span> <span class="kw">null</span> <span class="op">||</span></span>
<span id="cb26-565"><a href="#cb26-565" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span>) <span class="op">===</span> <span class="st">"none"</span></span>
<span id="cb26-566"><a href="#cb26-566" aria-hidden="true" tabindex="-1"></a>    ) {</span>
<span id="cb26-567"><a href="#cb26-567" aria-hidden="true" tabindex="-1"></a>      d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span> <span class="st">"visibleStroke"</span>)<span class="op">;</span></span>
<span id="cb26-568"><a href="#cb26-568" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (styles <span class="op">===</span> <span class="kw">undefined</span>) styles <span class="op">=</span> stroke_styles<span class="op">;</span></span>
<span id="cb26-569"><a href="#cb26-569" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-570"><a href="#cb26-570" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb26-571"><a href="#cb26-571" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-572"><a href="#cb26-572" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (styles <span class="op">===</span> <span class="kw">undefined</span>) styles <span class="op">=</span> fill_styles<span class="op">;</span></span>
<span id="cb26-573"><a href="#cb26-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-574"><a href="#cb26-574" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> tip <span class="op">=</span> wrapper</span>
<span id="cb26-575"><a href="#cb26-575" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">".hover"</span>)</span>
<span id="cb26-576"><a href="#cb26-576" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>([<span class="dv">1</span>])</span>
<span id="cb26-577"><a href="#cb26-577" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"g"</span>)</span>
<span id="cb26-578"><a href="#cb26-578" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"class"</span><span class="op">,</span> <span class="st">"hover"</span>)</span>
<span id="cb26-579"><a href="#cb26-579" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb26-580"><a href="#cb26-580" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)<span class="op">;</span></span>
<span id="cb26-581"><a href="#cb26-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-582"><a href="#cb26-582" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add a unique id to the chart for styling</span></span>
<span id="cb26-583"><a href="#cb26-583" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> id <span class="op">=</span> <span class="fu">id_generator</span>()<span class="op">;</span></span>
<span id="cb26-584"><a href="#cb26-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-585"><a href="#cb26-585" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add the event listeners</span></span>
<span id="cb26-586"><a href="#cb26-586" aria-hidden="true" tabindex="-1"></a>  d3<span class="op">.</span><span class="fu">select</span>(chart)<span class="op">.</span><span class="fu">classed</span>(id<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span> <span class="co">// using a class selector so that it doesn't overwrite the ID</span></span>
<span id="cb26-587"><a href="#cb26-587" aria-hidden="true" tabindex="-1"></a>  wrapper<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"title"</span>)<span class="op">.</span><span class="fu">each</span>(<span class="kw">function</span> () {</span>
<span id="cb26-588"><a href="#cb26-588" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Get the text out of the title, set it as an attribute on the parent, and remove it</span></span>
<span id="cb26-589"><a href="#cb26-589" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> title <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">;</span> <span class="co">// title element that we want to remove</span></span>
<span id="cb26-590"><a href="#cb26-590" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> parent <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span><span class="op">.</span><span class="at">parentNode</span>)<span class="op">;</span> <span class="co">// visual mark on the screen</span></span>
<span id="cb26-591"><a href="#cb26-591" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> t <span class="op">=</span> title<span class="op">.</span><span class="fu">text</span>()<span class="op">;</span></span>
<span id="cb26-592"><a href="#cb26-592" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (t) {</span>
<span id="cb26-593"><a href="#cb26-593" aria-hidden="true" tabindex="-1"></a>      parent<span class="op">.</span><span class="fu">attr</span>(<span class="st">"__title"</span><span class="op">,</span> t)<span class="op">.</span><span class="fu">classed</span>(<span class="st">"has-title"</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb26-594"><a href="#cb26-594" aria-hidden="true" tabindex="-1"></a>      title<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb26-595"><a href="#cb26-595" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-596"><a href="#cb26-596" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Mouse events</span></span>
<span id="cb26-597"><a href="#cb26-597" aria-hidden="true" tabindex="-1"></a>    parent</span>
<span id="cb26-598"><a href="#cb26-598" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"pointerenter pointermove"</span><span class="op">,</span> <span class="kw">function</span> (<span class="bu">event</span>) {</span>
<span id="cb26-599"><a href="#cb26-599" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> text <span class="op">=</span> d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">.</span><span class="fu">attr</span>(<span class="st">"__title"</span>)<span class="op">;</span></span>
<span id="cb26-600"><a href="#cb26-600" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> pointer <span class="op">=</span> d3<span class="op">.</span><span class="fu">pointer</span>(<span class="bu">event</span><span class="op">,</span> wrapper<span class="op">.</span><span class="fu">node</span>())<span class="op">;</span></span>
<span id="cb26-601"><a href="#cb26-601" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (text) tip<span class="op">.</span><span class="fu">call</span>(hover<span class="op">,</span> pointer<span class="op">,</span> text<span class="op">.</span><span class="fu">split</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))<span class="op">;</span></span>
<span id="cb26-602"><a href="#cb26-602" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> tip<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb26-603"><a href="#cb26-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-604"><a href="#cb26-604" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Raise it</span></span>
<span id="cb26-605"><a href="#cb26-605" aria-hidden="true" tabindex="-1"></a>        d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">.</span><span class="fu">raise</span>()<span class="op">;</span></span>
<span id="cb26-606"><a href="#cb26-606" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Keep within the parent horizontally</span></span>
<span id="cb26-607"><a href="#cb26-607" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> tipSize <span class="op">=</span> tip<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">getBBox</span>()<span class="op">;</span></span>
<span id="cb26-608"><a href="#cb26-608" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (pointer[<span class="dv">0</span>] <span class="op">+</span> tipSize<span class="op">.</span><span class="at">x</span> <span class="op">&lt;</span> <span class="dv">0</span>)</span>
<span id="cb26-609"><a href="#cb26-609" aria-hidden="true" tabindex="-1"></a>          tip<span class="op">.</span><span class="fu">attr</span>(</span>
<span id="cb26-610"><a href="#cb26-610" aria-hidden="true" tabindex="-1"></a>            <span class="st">"transform"</span><span class="op">,</span></span>
<span id="cb26-611"><a href="#cb26-611" aria-hidden="true" tabindex="-1"></a>            <span class="vs">`translate(</span><span class="sc">${</span>tipSize<span class="op">.</span><span class="at">width</span> <span class="op">/</span> <span class="dv">2</span><span class="sc">}</span><span class="vs">, </span><span class="sc">${</span>pointer[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">7</span><span class="sc">}</span><span class="vs">)`</span></span>
<span id="cb26-612"><a href="#cb26-612" aria-hidden="true" tabindex="-1"></a>          )<span class="op">;</span></span>
<span id="cb26-613"><a href="#cb26-613" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> <span class="cf">if</span> (pointer[<span class="dv">0</span>] <span class="op">+</span> tipSize<span class="op">.</span><span class="at">width</span> <span class="op">/</span> <span class="dv">2</span> <span class="op">&gt;</span> wrapper<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span>))</span>
<span id="cb26-614"><a href="#cb26-614" aria-hidden="true" tabindex="-1"></a>          tip<span class="op">.</span><span class="fu">attr</span>(</span>
<span id="cb26-615"><a href="#cb26-615" aria-hidden="true" tabindex="-1"></a>            <span class="st">"transform"</span><span class="op">,</span></span>
<span id="cb26-616"><a href="#cb26-616" aria-hidden="true" tabindex="-1"></a>            <span class="vs">`translate(</span><span class="sc">${</span>wrapper<span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span>) <span class="op">-</span> tipSize<span class="op">.</span><span class="at">width</span> <span class="op">/</span> <span class="dv">2</span><span class="sc">}</span><span class="vs">, </span><span class="sc">${</span></span>
<span id="cb26-617"><a href="#cb26-617" aria-hidden="true" tabindex="-1"></a>              pointer[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">7</span></span>
<span id="cb26-618"><a href="#cb26-618" aria-hidden="true" tabindex="-1"></a>            <span class="sc">}</span><span class="vs">)`</span></span>
<span id="cb26-619"><a href="#cb26-619" aria-hidden="true" tabindex="-1"></a>          )<span class="op">;</span></span>
<span id="cb26-620"><a href="#cb26-620" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb26-621"><a href="#cb26-621" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"pointerout"</span><span class="op">,</span> <span class="kw">function</span> (<span class="bu">event</span>) {</span>
<span id="cb26-622"><a href="#cb26-622" aria-hidden="true" tabindex="-1"></a>        tip<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb26-623"><a href="#cb26-623" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Lower it!</span></span>
<span id="cb26-624"><a href="#cb26-624" aria-hidden="true" tabindex="-1"></a>        d3<span class="op">.</span><span class="fu">select</span>(<span class="kw">this</span>)<span class="op">.</span><span class="fu">lower</span>()<span class="op">;</span></span>
<span id="cb26-625"><a href="#cb26-625" aria-hidden="true" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb26-626"><a href="#cb26-626" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb26-627"><a href="#cb26-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-628"><a href="#cb26-628" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Remove the tip if you tap on the wrapper (for mobile)</span></span>
<span id="cb26-629"><a href="#cb26-629" aria-hidden="true" tabindex="-1"></a>  wrapper<span class="op">.</span><span class="fu">on</span>(<span class="st">"touchstart"</span><span class="op">,</span> () <span class="kw">=&gt;</span> tip<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>())<span class="op">;</span></span>
<span id="cb26-630"><a href="#cb26-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-631"><a href="#cb26-631" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Define the styles</span></span>
<span id="cb26-632"><a href="#cb26-632" aria-hidden="true" tabindex="-1"></a>  chart<span class="op">.</span><span class="fu">appendChild</span>(<span class="fu">html</span><span class="vs">`&lt;style&gt;</span></span>
<span id="cb26-633"><a href="#cb26-633" aria-hidden="true" tabindex="-1"></a><span class="vs">  .</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs"> .has-title { cursor: pointer;  pointer-events: all; }</span></span>
<span id="cb26-634"><a href="#cb26-634" aria-hidden="true" tabindex="-1"></a><span class="vs">  .</span><span class="sc">${</span>id<span class="sc">}</span><span class="vs"> .has-title:hover { </span><span class="sc">${</span><span class="bu">Object</span><span class="op">.</span><span class="fu">entries</span>(styles)<span class="op">.</span><span class="fu">map</span>(([key<span class="op">,</span> value]) <span class="kw">=&gt;</span> <span class="vs">`</span><span class="sc">${</span>key<span class="sc">}</span><span class="vs">: </span><span class="sc">${</span>value<span class="sc">}</span><span class="vs">;`</span>)<span class="op">.</span><span class="fu">join</span>(<span class="st">" "</span>)<span class="sc">}</span><span class="vs"> }`</span>)<span class="op">;</span></span>
<span id="cb26-635"><a href="#cb26-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-636"><a href="#cb26-636" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> chart<span class="op">;</span></span>
<span id="cb26-637"><a href="#cb26-637" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27" data-startfrom="643" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 642;"><span id="cb27-643"><a href="#cb27-643" aria-hidden="true" tabindex="-1"></a><span class="co">// Source: https://observablehq.com/@mkfreeman/plot-tooltip</span></span>
<span id="cb27-644"><a href="#cb27-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-645"><a href="#cb27-645" aria-hidden="true" tabindex="-1"></a>hover <span class="op">=</span> (tip<span class="op">,</span> pos<span class="op">,</span> text) <span class="kw">=&gt;</span> {</span>
<span id="cb27-646"><a href="#cb27-646" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> side_padding <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb27-647"><a href="#cb27-647" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> vertical_padding <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb27-648"><a href="#cb27-648" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> vertical_offset <span class="op">=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb27-649"><a href="#cb27-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-650"><a href="#cb27-650" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Empty it out</span></span>
<span id="cb27-651"><a href="#cb27-651" aria-hidden="true" tabindex="-1"></a>  tip<span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"*"</span>)<span class="op">.</span><span class="fu">remove</span>()<span class="op">;</span></span>
<span id="cb27-652"><a href="#cb27-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-653"><a href="#cb27-653" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Append the text</span></span>
<span id="cb27-654"><a href="#cb27-654" aria-hidden="true" tabindex="-1"></a>  tip</span>
<span id="cb27-655"><a href="#cb27-655" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"text-anchor"</span><span class="op">,</span> <span class="st">"middle"</span>)</span>
<span id="cb27-656"><a href="#cb27-656" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"pointer-events"</span><span class="op">,</span> <span class="st">"none"</span>)</span>
<span id="cb27-657"><a href="#cb27-657" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"transform"</span><span class="op">,</span> <span class="vs">`translate(</span><span class="sc">${</span>pos[<span class="dv">0</span>]<span class="sc">}</span><span class="vs">, </span><span class="sc">${</span>pos[<span class="dv">1</span>] <span class="op">+</span> <span class="dv">7</span><span class="sc">}</span><span class="vs">)`</span>)</span>
<span id="cb27-658"><a href="#cb27-658" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"text"</span>)</span>
<span id="cb27-659"><a href="#cb27-659" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(text)</span>
<span id="cb27-660"><a href="#cb27-660" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"text"</span>)</span>
<span id="cb27-661"><a href="#cb27-661" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"dominant-baseline"</span><span class="op">,</span> <span class="st">"ideographic"</span>)</span>
<span id="cb27-662"><a href="#cb27-662" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">text</span>((d) <span class="kw">=&gt;</span> d)</span>
<span id="cb27-663"><a href="#cb27-663" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> (d<span class="op">,</span> i) <span class="kw">=&gt;</span> (i <span class="op">-</span> (text<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>)) <span class="op">*</span> <span class="dv">15</span> <span class="op">-</span> vertical_offset)</span>
<span id="cb27-664"><a href="#cb27-664" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"font-weight"</span><span class="op">,</span> (d<span class="op">,</span> i) <span class="kw">=&gt;</span> (i <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="st">"bold"</span> <span class="op">:</span> <span class="st">"normal"</span>))<span class="op">;</span></span>
<span id="cb27-665"><a href="#cb27-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-666"><a href="#cb27-666" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> bbox <span class="op">=</span> tip<span class="op">.</span><span class="fu">node</span>()<span class="op">.</span><span class="fu">getBBox</span>()<span class="op">;</span></span>
<span id="cb27-667"><a href="#cb27-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-668"><a href="#cb27-668" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add a rectangle (as background)</span></span>
<span id="cb27-669"><a href="#cb27-669" aria-hidden="true" tabindex="-1"></a>  tip</span>
<span id="cb27-670"><a href="#cb27-670" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">append</span>(<span class="st">"rect"</span>)</span>
<span id="cb27-671"><a href="#cb27-671" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">y</span> <span class="op">-</span> vertical_padding)</span>
<span id="cb27-672"><a href="#cb27-672" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">x</span> <span class="op">-</span> side_padding)</span>
<span id="cb27-673"><a href="#cb27-673" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">width</span> <span class="op">+</span> side_padding <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb27-674"><a href="#cb27-674" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> bbox<span class="op">.</span><span class="at">height</span> <span class="op">+</span> vertical_padding <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb27-675"><a href="#cb27-675" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"fill"</span><span class="op">,</span> <span class="st">"white"</span>)</span>
<span id="cb27-676"><a href="#cb27-676" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">style</span>(<span class="st">"stroke"</span><span class="op">,</span> <span class="st">"#d3d3d3"</span>)</span>
<span id="cb27-677"><a href="#cb27-677" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">lower</span>()<span class="op">;</span></span>
<span id="cb27-678"><a href="#cb27-678" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28" data-startfrom="684" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 683;"><span id="cb28-684"><a href="#cb28-684" aria-hidden="true" tabindex="-1"></a><span class="co">// Source: https://observablehq.com/@mkfreeman/plot-tooltip</span></span>
<span id="cb28-685"><a href="#cb28-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-686"><a href="#cb28-686" aria-hidden="true" tabindex="-1"></a>id_generator <span class="op">=</span> () <span class="kw">=&gt;</span> {</span>
<span id="cb28-687"><a href="#cb28-687" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> S4 <span class="op">=</span> <span class="kw">function</span> () {</span>
<span id="cb28-688"><a href="#cb28-688" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (((<span class="dv">1</span> <span class="op">+</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">random</span>()) <span class="op">*</span> <span class="bn">0x10000</span>) <span class="op">|</span> <span class="dv">0</span>)<span class="op">.</span><span class="fu">toString</span>(<span class="dv">16</span>)<span class="op">.</span><span class="fu">substring</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb28-689"><a href="#cb28-689" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb28-690"><a href="#cb28-690" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="st">"a"</span> <span class="op">+</span> <span class="fu">S4</span>() <span class="op">+</span> <span class="fu">S4</span>()<span class="op">;</span></span>
<span id="cb28-691"><a href="#cb28-691" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-7" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29" data-startfrom="697" data-source-offset="0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 696;"><span id="cb29-697"><a href="#cb29-697" aria-hidden="true" tabindex="-1"></a><span class="co">// Copyright 2021 Observable, Inc.</span></span>
<span id="cb29-698"><a href="#cb29-698" aria-hidden="true" tabindex="-1"></a><span class="co">// Released under the ISC license.</span></span>
<span id="cb29-699"><a href="#cb29-699" aria-hidden="true" tabindex="-1"></a><span class="co">// https://observablehq.com/@d3/disjoint-force-directed-graph</span></span>
<span id="cb29-700"><a href="#cb29-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-701"><a href="#cb29-701" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">ForceGraph</span>({</span>
<span id="cb29-702"><a href="#cb29-702" aria-hidden="true" tabindex="-1"></a>  nodes<span class="op">,</span> <span class="co">// an iterable of node objects (typically [{id}, …])</span></span>
<span id="cb29-703"><a href="#cb29-703" aria-hidden="true" tabindex="-1"></a>  links <span class="co">// an iterable of link objects (typically [{source, target}, …])</span></span>
<span id="cb29-704"><a href="#cb29-704" aria-hidden="true" tabindex="-1"></a>}<span class="op">,</span> {</span>
<span id="cb29-705"><a href="#cb29-705" aria-hidden="true" tabindex="-1"></a>  nodeId <span class="op">=</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">id</span><span class="op">,</span> <span class="co">// given d in nodes, returns a unique identifier (string)</span></span>
<span id="cb29-706"><a href="#cb29-706" aria-hidden="true" tabindex="-1"></a>  nodeGroup<span class="op">,</span> <span class="co">// given d in nodes, returns an (ordinal) value for color</span></span>
<span id="cb29-707"><a href="#cb29-707" aria-hidden="true" tabindex="-1"></a>  nodeGroups<span class="op">,</span> <span class="co">// an array of ordinal values representing the node groups</span></span>
<span id="cb29-708"><a href="#cb29-708" aria-hidden="true" tabindex="-1"></a>  nodeTitle<span class="op">,</span> <span class="co">// given d in nodes, a title string</span></span>
<span id="cb29-709"><a href="#cb29-709" aria-hidden="true" tabindex="-1"></a>  nodeFill <span class="op">=</span> <span class="st">"currentColor"</span><span class="op">,</span> <span class="co">// node stroke fill (if not using a group color encoding)</span></span>
<span id="cb29-710"><a href="#cb29-710" aria-hidden="true" tabindex="-1"></a>  nodeStroke <span class="op">=</span> <span class="st">"#fff"</span><span class="op">,</span> <span class="co">// node stroke color</span></span>
<span id="cb29-711"><a href="#cb29-711" aria-hidden="true" tabindex="-1"></a>  nodeStrokeWidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">,</span> <span class="co">// node stroke width, in pixels</span></span>
<span id="cb29-712"><a href="#cb29-712" aria-hidden="true" tabindex="-1"></a>  nodeStrokeOpacity <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="co">// node stroke opacity</span></span>
<span id="cb29-713"><a href="#cb29-713" aria-hidden="true" tabindex="-1"></a>  nodeRadius <span class="op">=</span> <span class="dv">5</span><span class="op">,</span> <span class="co">// node radius, in pixels</span></span>
<span id="cb29-714"><a href="#cb29-714" aria-hidden="true" tabindex="-1"></a>  nodeStrength<span class="op">,</span></span>
<span id="cb29-715"><a href="#cb29-715" aria-hidden="true" tabindex="-1"></a>  linkSource <span class="op">=</span> ({source}) <span class="kw">=&gt;</span> source<span class="op">,</span> <span class="co">// given d in links, returns a node identifier string</span></span>
<span id="cb29-716"><a href="#cb29-716" aria-hidden="true" tabindex="-1"></a>  linkTarget <span class="op">=</span> ({target}) <span class="kw">=&gt;</span> target<span class="op">,</span> <span class="co">// given d in links, returns a node identifier string</span></span>
<span id="cb29-717"><a href="#cb29-717" aria-hidden="true" tabindex="-1"></a>  linkStroke <span class="op">=</span> <span class="st">"#999"</span><span class="op">,</span> <span class="co">// link stroke color</span></span>
<span id="cb29-718"><a href="#cb29-718" aria-hidden="true" tabindex="-1"></a>  linkStrokeOpacity <span class="op">=</span> <span class="fl">0.6</span><span class="op">,</span> <span class="co">// link stroke opacity</span></span>
<span id="cb29-719"><a href="#cb29-719" aria-hidden="true" tabindex="-1"></a>  linkStrokeWidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">,</span> <span class="co">// given d in links, returns a stroke width in pixels</span></span>
<span id="cb29-720"><a href="#cb29-720" aria-hidden="true" tabindex="-1"></a>  linkStrokeLinecap <span class="op">=</span> <span class="st">"round"</span><span class="op">,</span> <span class="co">// link stroke linecap</span></span>
<span id="cb29-721"><a href="#cb29-721" aria-hidden="true" tabindex="-1"></a>  linkStrength<span class="op">,</span></span>
<span id="cb29-722"><a href="#cb29-722" aria-hidden="true" tabindex="-1"></a>  colors <span class="op">=</span> d3<span class="op">.</span><span class="at">schemeTableau10</span><span class="op">,</span> <span class="co">// an array of color strings, for the node groups</span></span>
<span id="cb29-723"><a href="#cb29-723" aria-hidden="true" tabindex="-1"></a>  width <span class="op">=</span> <span class="dv">640</span><span class="op">,</span> <span class="co">// outer width, in pixels</span></span>
<span id="cb29-724"><a href="#cb29-724" aria-hidden="true" tabindex="-1"></a>  height <span class="op">=</span> <span class="dv">400</span><span class="op">,</span> <span class="co">// outer height, in pixels</span></span>
<span id="cb29-725"><a href="#cb29-725" aria-hidden="true" tabindex="-1"></a>  invalidation <span class="co">// when this promise resolves, stop the simulation</span></span>
<span id="cb29-726"><a href="#cb29-726" aria-hidden="true" tabindex="-1"></a>} <span class="op">=</span> {}) {</span>
<span id="cb29-727"><a href="#cb29-727" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute values.</span></span>
<span id="cb29-728"><a href="#cb29-728" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> N <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> nodeId)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb29-729"><a href="#cb29-729" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> LS <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkSource)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb29-730"><a href="#cb29-730" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> LT <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkTarget)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb29-731"><a href="#cb29-731" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (nodeTitle <span class="op">===</span> <span class="kw">undefined</span>) nodeTitle <span class="op">=</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> N[i]<span class="op">;</span></span>
<span id="cb29-732"><a href="#cb29-732" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> T <span class="op">=</span> nodeTitle <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> nodeTitle)<span class="op">;</span></span>
<span id="cb29-733"><a href="#cb29-733" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> G <span class="op">=</span> nodeGroup <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> nodeGroup)<span class="op">.</span><span class="fu">map</span>(intern)<span class="op">;</span></span>
<span id="cb29-734"><a href="#cb29-734" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> W <span class="op">=</span> <span class="kw">typeof</span> linkStrokeWidth <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> linkStrokeWidth)<span class="op">;</span></span>
<span id="cb29-735"><a href="#cb29-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-736"><a href="#cb29-736" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Replace the input nodes and links with mutable objects for the simulation.</span></span>
<span id="cb29-737"><a href="#cb29-737" aria-hidden="true" tabindex="-1"></a>  nodes <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(nodes<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> ({<span class="dt">id</span><span class="op">:</span> N[i]}))<span class="op">;</span></span>
<span id="cb29-738"><a href="#cb29-738" aria-hidden="true" tabindex="-1"></a>  links <span class="op">=</span> d3<span class="op">.</span><span class="fu">map</span>(links<span class="op">,</span> (_<span class="op">,</span> i) <span class="kw">=&gt;</span> ({<span class="dt">source</span><span class="op">:</span> LS[i]<span class="op">,</span> <span class="dt">target</span><span class="op">:</span> LT[i]}))<span class="op">;</span></span>
<span id="cb29-739"><a href="#cb29-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-740"><a href="#cb29-740" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute default domains.</span></span>
<span id="cb29-741"><a href="#cb29-741" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (G <span class="op">&amp;&amp;</span> nodeGroups <span class="op">===</span> <span class="kw">undefined</span>) nodeGroups <span class="op">=</span> d3<span class="op">.</span><span class="fu">sort</span>(G)<span class="op">;</span></span>
<span id="cb29-742"><a href="#cb29-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-743"><a href="#cb29-743" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct the scales.</span></span>
<span id="cb29-744"><a href="#cb29-744" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> color <span class="op">=</span> nodeGroup <span class="op">==</span> <span class="kw">null</span> <span class="op">?</span> <span class="kw">null</span> <span class="op">:</span> d3<span class="op">.</span><span class="fu">scaleOrdinal</span>(nodeGroups<span class="op">,</span> colors)<span class="op">;</span></span>
<span id="cb29-745"><a href="#cb29-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-746"><a href="#cb29-746" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Construct the forces.</span></span>
<span id="cb29-747"><a href="#cb29-747" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> forceNode <span class="op">=</span> d3<span class="op">.</span><span class="fu">forceManyBody</span>()<span class="op">;</span></span>
<span id="cb29-748"><a href="#cb29-748" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> forceLink <span class="op">=</span> d3<span class="op">.</span><span class="fu">forceLink</span>(links)<span class="op">.</span><span class="fu">id</span>(({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> N[i])<span class="op">;</span></span>
<span id="cb29-749"><a href="#cb29-749" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (nodeStrength <span class="op">!==</span> <span class="kw">undefined</span>) forceNode<span class="op">.</span><span class="fu">strength</span>(nodeStrength)<span class="op">;</span></span>
<span id="cb29-750"><a href="#cb29-750" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (linkStrength <span class="op">!==</span> <span class="kw">undefined</span>) forceLink<span class="op">.</span><span class="fu">strength</span>(linkStrength)<span class="op">;</span></span>
<span id="cb29-751"><a href="#cb29-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-752"><a href="#cb29-752" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> simulation <span class="op">=</span> d3<span class="op">.</span><span class="fu">forceSimulation</span>(nodes)</span>
<span id="cb29-753"><a href="#cb29-753" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"link"</span><span class="op">,</span> forceLink)</span>
<span id="cb29-754"><a href="#cb29-754" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"charge"</span><span class="op">,</span> forceNode)</span>
<span id="cb29-755"><a href="#cb29-755" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"x"</span><span class="op">,</span> d3<span class="op">.</span><span class="fu">forceX</span>())</span>
<span id="cb29-756"><a href="#cb29-756" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">force</span>(<span class="st">"y"</span><span class="op">,</span> d3<span class="op">.</span><span class="fu">forceY</span>())</span>
<span id="cb29-757"><a href="#cb29-757" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"tick"</span><span class="op">,</span> ticked)</span>
<span id="cb29-758"><a href="#cb29-758" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">alphaDecay</span>(<span class="dv">0</span>)<span class="op">;</span> <span class="co">// Added by me: keepp the chart in perpetual motion</span></span>
<span id="cb29-759"><a href="#cb29-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-760"><a href="#cb29-760" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> svg <span class="op">=</span> d3<span class="op">.</span><span class="fu">create</span>(<span class="st">"svg"</span>)</span>
<span id="cb29-761"><a href="#cb29-761" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"width"</span><span class="op">,</span> width)</span>
<span id="cb29-762"><a href="#cb29-762" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"height"</span><span class="op">,</span> height)</span>
<span id="cb29-763"><a href="#cb29-763" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"viewBox"</span><span class="op">,</span> [<span class="op">-</span>width <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> <span class="op">-</span>height <span class="op">/</span> <span class="dv">2</span><span class="op">,</span> width<span class="op">,</span> height])</span>
<span id="cb29-764"><a href="#cb29-764" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"style"</span><span class="op">,</span> <span class="st">"max-width: 100%; height: auto; height: intrinsic;"</span>)<span class="op">;</span></span>
<span id="cb29-765"><a href="#cb29-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-766"><a href="#cb29-766" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> link <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb29-767"><a href="#cb29-767" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> linkStroke)</span>
<span id="cb29-768"><a href="#cb29-768" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> linkStrokeOpacity)</span>
<span id="cb29-769"><a href="#cb29-769" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> <span class="kw">typeof</span> linkStrokeWidth <span class="op">!==</span> <span class="st">"function"</span> <span class="op">?</span> linkStrokeWidth <span class="op">:</span> <span class="kw">null</span>)</span>
<span id="cb29-770"><a href="#cb29-770" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-linecap"</span><span class="op">,</span> linkStrokeLinecap)</span>
<span id="cb29-771"><a href="#cb29-771" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"line"</span>)</span>
<span id="cb29-772"><a href="#cb29-772" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(links)</span>
<span id="cb29-773"><a href="#cb29-773" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"line"</span>)<span class="op">;</span></span>
<span id="cb29-774"><a href="#cb29-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-775"><a href="#cb29-775" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (W) link<span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> ({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> W[i])<span class="op">;</span></span>
<span id="cb29-776"><a href="#cb29-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-777"><a href="#cb29-777" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> node <span class="op">=</span> svg<span class="op">.</span><span class="fu">append</span>(<span class="st">"g"</span>)</span>
<span id="cb29-778"><a href="#cb29-778" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> nodeFill)</span>
<span id="cb29-779"><a href="#cb29-779" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke"</span><span class="op">,</span> nodeStroke)</span>
<span id="cb29-780"><a href="#cb29-780" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-opacity"</span><span class="op">,</span> nodeStrokeOpacity)</span>
<span id="cb29-781"><a href="#cb29-781" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"stroke-width"</span><span class="op">,</span> nodeStrokeWidth)</span>
<span id="cb29-782"><a href="#cb29-782" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">selectAll</span>(<span class="st">"circle"</span>)</span>
<span id="cb29-783"><a href="#cb29-783" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">data</span>(nodes)</span>
<span id="cb29-784"><a href="#cb29-784" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">join</span>(<span class="st">"circle"</span>)</span>
<span id="cb29-785"><a href="#cb29-785" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"r"</span><span class="op">,</span> nodeRadius)</span>
<span id="cb29-786"><a href="#cb29-786" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">call</span>(<span class="fu">drag</span>(simulation))<span class="op">;</span></span>
<span id="cb29-787"><a href="#cb29-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-788"><a href="#cb29-788" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (G) node<span class="op">.</span><span class="fu">attr</span>(<span class="st">"fill"</span><span class="op">,</span> ({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> <span class="fu">color</span>(G[i]))<span class="op">;</span></span>
<span id="cb29-789"><a href="#cb29-789" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (T) node<span class="op">.</span><span class="fu">append</span>(<span class="st">"title"</span>)<span class="op">.</span><span class="fu">text</span>(({<span class="dt">index</span><span class="op">:</span> i}) <span class="kw">=&gt;</span> T[i])<span class="op">;</span></span>
<span id="cb29-790"><a href="#cb29-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-791"><a href="#cb29-791" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle invalidation.</span></span>
<span id="cb29-792"><a href="#cb29-792" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (invalidation <span class="op">!=</span> <span class="kw">null</span>) invalidation<span class="op">.</span><span class="fu">then</span>(() <span class="kw">=&gt;</span> simulation<span class="op">.</span><span class="fu">stop</span>())<span class="op">;</span></span>
<span id="cb29-793"><a href="#cb29-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-794"><a href="#cb29-794" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">intern</span>(value) {</span>
<span id="cb29-795"><a href="#cb29-795" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> value <span class="op">!==</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> <span class="kw">typeof</span> value <span class="op">===</span> <span class="st">"object"</span> <span class="op">?</span> value<span class="op">.</span><span class="fu">valueOf</span>() <span class="op">:</span> value<span class="op">;</span></span>
<span id="cb29-796"><a href="#cb29-796" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-797"><a href="#cb29-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-798"><a href="#cb29-798" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">ticked</span>() {</span>
<span id="cb29-799"><a href="#cb29-799" aria-hidden="true" tabindex="-1"></a>    link</span>
<span id="cb29-800"><a href="#cb29-800" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x1"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">source</span><span class="op">.</span><span class="at">x</span>)</span>
<span id="cb29-801"><a href="#cb29-801" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y1"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">source</span><span class="op">.</span><span class="at">y</span>)</span>
<span id="cb29-802"><a href="#cb29-802" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"x2"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">x</span>)</span>
<span id="cb29-803"><a href="#cb29-803" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"y2"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">target</span><span class="op">.</span><span class="at">y</span>)<span class="op">;</span></span>
<span id="cb29-804"><a href="#cb29-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-805"><a href="#cb29-805" aria-hidden="true" tabindex="-1"></a>    node</span>
<span id="cb29-806"><a href="#cb29-806" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cx"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">x</span>)</span>
<span id="cb29-807"><a href="#cb29-807" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">attr</span>(<span class="st">"cy"</span><span class="op">,</span> d <span class="kw">=&gt;</span> d<span class="op">.</span><span class="at">y</span>)<span class="op">;</span></span>
<span id="cb29-808"><a href="#cb29-808" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-809"><a href="#cb29-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-810"><a href="#cb29-810" aria-hidden="true" tabindex="-1"></a>  <span class="kw">function</span> <span class="fu">drag</span>(simulation) {    </span>
<span id="cb29-811"><a href="#cb29-811" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dragstarted</span>(<span class="bu">event</span>) {</span>
<span id="cb29-812"><a href="#cb29-812" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="bu">event</span><span class="op">.</span><span class="at">active</span>) simulation<span class="op">.</span><span class="fu">alphaTarget</span>(<span class="fl">0.3</span>)<span class="op">.</span><span class="fu">restart</span>()<span class="op">;</span></span>
<span id="cb29-813"><a href="#cb29-813" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fx</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">x</span><span class="op">;</span></span>
<span id="cb29-814"><a href="#cb29-814" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fy</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">y</span><span class="op">;</span></span>
<span id="cb29-815"><a href="#cb29-815" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-816"><a href="#cb29-816" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-817"><a href="#cb29-817" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dragged</span>(<span class="bu">event</span>) {</span>
<span id="cb29-818"><a href="#cb29-818" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fx</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">x</span><span class="op">;</span></span>
<span id="cb29-819"><a href="#cb29-819" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fy</span> <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">y</span><span class="op">;</span></span>
<span id="cb29-820"><a href="#cb29-820" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-821"><a href="#cb29-821" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-822"><a href="#cb29-822" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">dragended</span>(<span class="bu">event</span>) {</span>
<span id="cb29-823"><a href="#cb29-823" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="op">!</span><span class="bu">event</span><span class="op">.</span><span class="at">active</span>) simulation<span class="op">.</span><span class="fu">alphaTarget</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb29-824"><a href="#cb29-824" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fx</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb29-825"><a href="#cb29-825" aria-hidden="true" tabindex="-1"></a>      <span class="bu">event</span><span class="op">.</span><span class="at">subject</span><span class="op">.</span><span class="at">fy</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb29-826"><a href="#cb29-826" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-827"><a href="#cb29-827" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-828"><a href="#cb29-828" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d3<span class="op">.</span><span class="fu">drag</span>()</span>
<span id="cb29-829"><a href="#cb29-829" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"start"</span><span class="op">,</span> dragstarted)</span>
<span id="cb29-830"><a href="#cb29-830" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"drag"</span><span class="op">,</span> dragged)</span>
<span id="cb29-831"><a href="#cb29-831" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">on</span>(<span class="st">"end"</span><span class="op">,</span> dragended)<span class="op">;</span></span>
<span id="cb29-832"><a href="#cb29-832" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-833"><a href="#cb29-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-834"><a href="#cb29-834" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">Object</span><span class="op">.</span><span class="fu">assign</span>(svg<span class="op">.</span><span class="fu">node</span>()<span class="op">,</span> {<span class="dt">scales</span><span class="op">:</span> {color}})<span class="op">;</span></span>
<span id="cb29-835"><a href="#cb29-835" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-display">
<div id="ojs-cell-8" data-nodetype="declaration">

</div>
</div>
</div>



<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section></div></main> <!-- /main -->

<script type="ojs-module-contents">
{"contents":[{"methodName":"interpret","cellName":"ojs-cell-1","inline":false,"source":"library_network = FileAttachment('../../datasets/literary/library_network.json').json({typed: true})\n\naddTooltips(\n  ForceGraph(\n    library_network, \n    {\n      nodeId: d => d.id,\n      nodeGroup: d => d.nationality,\n      nodeTitle: d => `${d.title}\\n${d.query} (${d.nationality})`,\n      nodeStrokeOpacity: .7,\n      linkStrokeWidth: l => Math.sqrt(l.value),\n      nodeRadius: 6,\n      width: 800, height: 750,\n      colors: [\"#B13D70\", \"#7fc6a4\", \"#4889ab\", \"#F7DD72\"]\n    }\n  ),\n  {r: 7, opacity: 1, \"stroke-width\": \"2px\", stroke: \"black\"}\n)\n"},{"methodName":"interpret","cellName":"ojs-cell-2","inline":false,"source":"library_stats = FileAttachment('../../datasets/literary/library_stats.csv').csv({typed: true})\n"},{"methodName":"interpret","cellName":"ojs-cell-3","inline":false,"source":"\nviewof highlight_a = Inputs.select(\n  d3.group(library_stats, d => d.query), \n  {label: html`<b>Highlight an author</b>`, key: \"Herman Melville\"}\n)\n\nviewof parlength_max = Inputs.range(\n  [100, 650], \n  {label: html`<b>Paragraph length</b>`, value: 200, step: 1}\n)\n\naddTooltips(\n  Plot.plot({\n    marks: [\n      Plot.frame({fill: \"#f7f7f7\"}),\n      Plot.dot(\n        library_stats.filter(d => d.parlength < parlength_max), \n        {\n          x: \"parlength\", y: \"sentiment\", \n          r: 6, fill: \"nationality\", fillOpacity: 0.75, \n          stroke: \"white\", strokeWidth: 1, strokeOpacity: .7,\n          title: (d) => `${d.title}\\n${d.query} (${d.nationality})`\n        }),\n      Plot.dot(\n        highlight_a.filter(d => d.parlength < parlength_max), \n        {\n          x: \"parlength\", y: \"sentiment\", \n          r: 7, stroke: \"black\", strokeWidth: 3\n        })\n    ],\n    x: {\n      label: \"Average paragraph wordcount\",\n      labelAnchor: \"center\",\n      ticks: 5, tickSize: 0, grid: false,\n      domain: [d3.min(library_stats, d => d.parlength), parlength_max]\n    },\n    y: {\n      label: \"Sentiment\",\n      labelAnchor: \"center\",\n      ticks: 5, tickSize: 0, grid: false,\n      domain: d3.extent(library_stats, d => d.sentiment)\n    },\n    color: { \n      legend: true, \n      range: [\"#B13D70\", \"#7fc6a4\", \"#4889ab\", \"#F7DD72\"],\n    },\n    width: 800, height: 500,\n    marginTop: 15, marginBottom: 45, marginLeft: 65, \n    insetTop: 20, insetRight: 20, insetBottom: 20, insetLeft: 20\n  }),\n  {r: 6, opacity: .8, \"stroke-width\": \"3px\", stroke: \"black\"}\n)\n"},{"methodName":"interpret","cellName":"ojs-cell-4","inline":false,"source":"\nviewof highlight_b = Inputs.select(\n  d3.group(library_stats, d => d.query), \n  {label: html`<b>Highlight an author</b>`, key: \"Herman Melville\"}\n)\n\naddTooltips(\n  Plot.plot({\n    marks: [\n      Plot.frame({fill: \"#f7f7f7\"}),\n      Plot.dot(\n        library_stats, \n        {\n          x: \"x\", y: \"y\", \n          r: 6, fill: \"nationality\", fillOpacity: 0.75, \n          stroke: \"white\", strokeWidth: 1, strokeOpacity: .7,\n          title: (d) => `${d.title} \\n ${d.query} (${d.nationality})`\n        }),\n      Plot.dot(\n        highlight_b, \n        {\n          x: \"x\", y: \"y\", \n          r: 7, stroke: \"black\", strokeWidth: 3\n        })\n    ],\n    x: {label: null, ticks: 0},\n    y: {label: null, ticks: 0},\n    color: { \n      legend: true, \n      range: [\"#B13D70\", \"#7fc6a4\", \"#4889ab\", \"#F7DD72\"],\n    },\n    width: 800, height: 500,\n    marginTop: 15, marginBottom: 0, marginLeft: 0, \n    insetTop: 20, insetRight: 20, insetBottom: 20, insetLeft: 20\n  }),\n  {r: 6, opacity: .8, \"stroke-width\": \"3px\", stroke: \"black\"}\n)\n"},{"methodName":"interpret","cellName":"ojs-cell-5","inline":false,"source":"\n// Source: https://observablehq.com/@mkfreeman/plot-tooltip\n\naddTooltips = (chart, styles) => {\n  const stroke_styles = { stroke: \"blue\", \"stroke-width\": 3 };\n  const fill_styles = { fill: \"blue\", opacity: 0.5 };\n\n  // Workaround if it's in a figure\n  const type = d3.select(chart).node().tagName;\n  let wrapper =\n    type === \"FIGURE\" ? d3.select(chart).select(\"svg\") : d3.select(chart);\n\n  // Workaround if there's a legend....\n  const svgs = d3.select(chart).selectAll(\"svg\");\n  if (svgs.size() > 1) wrapper = d3.select([...svgs].pop());\n  wrapper.style(\"overflow\", \"visible\"); // to avoid clipping at the edges\n\n  // Set pointer events to visibleStroke if the fill is none (e.g., if its a line)\n  wrapper.selectAll(\"path\").each(function (data, index, nodes) {\n    // For line charts, set the pointer events to be visible stroke\n    if (\n      d3.select(this).attr(\"fill\") === null ||\n      d3.select(this).attr(\"fill\") === \"none\"\n    ) {\n      d3.select(this).style(\"pointer-events\", \"visibleStroke\");\n      if (styles === undefined) styles = stroke_styles;\n    }\n  });\n  \n  if (styles === undefined) styles = fill_styles;\n\n  const tip = wrapper\n    .selectAll(\".hover\")\n    .data([1])\n    .join(\"g\")\n    .attr(\"class\", \"hover\")\n    .style(\"pointer-events\", \"none\")\n    .style(\"text-anchor\", \"middle\");\n\n  // Add a unique id to the chart for styling\n  const id = id_generator();\n\n  // Add the event listeners\n  d3.select(chart).classed(id, true); // using a class selector so that it doesn't overwrite the ID\n  wrapper.selectAll(\"title\").each(function () {\n    // Get the text out of the title, set it as an attribute on the parent, and remove it\n    const title = d3.select(this); // title element that we want to remove\n    const parent = d3.select(this.parentNode); // visual mark on the screen\n    const t = title.text();\n    if (t) {\n      parent.attr(\"__title\", t).classed(\"has-title\", true);\n      title.remove();\n    }\n    // Mouse events\n    parent\n      .on(\"pointerenter pointermove\", function (event) {\n        const text = d3.select(this).attr(\"__title\");\n        const pointer = d3.pointer(event, wrapper.node());\n        if (text) tip.call(hover, pointer, text.split(\"\\n\"));\n        else tip.selectAll(\"*\").remove();\n\n        // Raise it\n        d3.select(this).raise();\n        // Keep within the parent horizontally\n        const tipSize = tip.node().getBBox();\n        if (pointer[0] + tipSize.x < 0)\n          tip.attr(\n            \"transform\",\n            `translate(${tipSize.width / 2}, ${pointer[1] + 7})`\n          );\n        else if (pointer[0] + tipSize.width / 2 > wrapper.attr(\"width\"))\n          tip.attr(\n            \"transform\",\n            `translate(${wrapper.attr(\"width\") - tipSize.width / 2}, ${\n              pointer[1] + 7\n            })`\n          );\n      })\n      .on(\"pointerout\", function (event) {\n        tip.selectAll(\"*\").remove();\n        // Lower it!\n        d3.select(this).lower();\n      });\n  });\n\n  // Remove the tip if you tap on the wrapper (for mobile)\n  wrapper.on(\"touchstart\", () => tip.selectAll(\"*\").remove());\n\n  // Define the styles\n  chart.appendChild(html`<style>\n  .${id} .has-title { cursor: pointer;  pointer-events: all; }\n  .${id} .has-title:hover { ${Object.entries(styles).map(([key, value]) => `${key}: ${value};`).join(\" \")} }`);\n\n  return chart;\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-6","inline":false,"source":"\n// Source: https://observablehq.com/@mkfreeman/plot-tooltip\n\nhover = (tip, pos, text) => {\n  const side_padding = 10;\n  const vertical_padding = 5;\n  const vertical_offset = 25;\n\n  // Empty it out\n  tip.selectAll(\"*\").remove();\n\n  // Append the text\n  tip\n    .style(\"text-anchor\", \"middle\")\n    .style(\"pointer-events\", \"none\")\n    .attr(\"transform\", `translate(${pos[0]}, ${pos[1] + 7})`)\n    .selectAll(\"text\")\n    .data(text)\n    .join(\"text\")\n    .style(\"dominant-baseline\", \"ideographic\")\n    .text((d) => d)\n    .attr(\"y\", (d, i) => (i - (text.length - 1)) * 15 - vertical_offset)\n    .style(\"font-weight\", (d, i) => (i === 0 ? \"bold\" : \"normal\"));\n\n  const bbox = tip.node().getBBox();\n\n  // Add a rectangle (as background)\n  tip\n    .append(\"rect\")\n    .attr(\"y\", bbox.y - vertical_padding)\n    .attr(\"x\", bbox.x - side_padding)\n    .attr(\"width\", bbox.width + side_padding * 2)\n    .attr(\"height\", bbox.height + vertical_padding * 2)\n    .style(\"fill\", \"white\")\n    .style(\"stroke\", \"#d3d3d3\")\n    .lower();\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-7","inline":false,"source":"\n// Source: https://observablehq.com/@mkfreeman/plot-tooltip\n\nid_generator = () => {\n  var S4 = function () {\n    return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);\n  };\n  return \"a\" + S4() + S4();\n}\n"},{"methodName":"interpret","cellName":"ojs-cell-8","inline":false,"source":"\n// Copyright 2021 Observable, Inc.\n// Released under the ISC license.\n// https://observablehq.com/@d3/disjoint-force-directed-graph\n\nfunction ForceGraph({\n  nodes, // an iterable of node objects (typically [{id}, …])\n  links // an iterable of link objects (typically [{source, target}, …])\n}, {\n  nodeId = d => d.id, // given d in nodes, returns a unique identifier (string)\n  nodeGroup, // given d in nodes, returns an (ordinal) value for color\n  nodeGroups, // an array of ordinal values representing the node groups\n  nodeTitle, // given d in nodes, a title string\n  nodeFill = \"currentColor\", // node stroke fill (if not using a group color encoding)\n  nodeStroke = \"#fff\", // node stroke color\n  nodeStrokeWidth = 1.5, // node stroke width, in pixels\n  nodeStrokeOpacity = 1, // node stroke opacity\n  nodeRadius = 5, // node radius, in pixels\n  nodeStrength,\n  linkSource = ({source}) => source, // given d in links, returns a node identifier string\n  linkTarget = ({target}) => target, // given d in links, returns a node identifier string\n  linkStroke = \"#999\", // link stroke color\n  linkStrokeOpacity = 0.6, // link stroke opacity\n  linkStrokeWidth = 1.5, // given d in links, returns a stroke width in pixels\n  linkStrokeLinecap = \"round\", // link stroke linecap\n  linkStrength,\n  colors = d3.schemeTableau10, // an array of color strings, for the node groups\n  width = 640, // outer width, in pixels\n  height = 400, // outer height, in pixels\n  invalidation // when this promise resolves, stop the simulation\n} = {}) {\n  // Compute values.\n  const N = d3.map(nodes, nodeId).map(intern);\n  const LS = d3.map(links, linkSource).map(intern);\n  const LT = d3.map(links, linkTarget).map(intern);\n  if (nodeTitle === undefined) nodeTitle = (_, i) => N[i];\n  const T = nodeTitle == null ? null : d3.map(nodes, nodeTitle);\n  const G = nodeGroup == null ? null : d3.map(nodes, nodeGroup).map(intern);\n  const W = typeof linkStrokeWidth !== \"function\" ? null : d3.map(links, linkStrokeWidth);\n\n  // Replace the input nodes and links with mutable objects for the simulation.\n  nodes = d3.map(nodes, (_, i) => ({id: N[i]}));\n  links = d3.map(links, (_, i) => ({source: LS[i], target: LT[i]}));\n\n  // Compute default domains.\n  if (G && nodeGroups === undefined) nodeGroups = d3.sort(G);\n\n  // Construct the scales.\n  const color = nodeGroup == null ? null : d3.scaleOrdinal(nodeGroups, colors);\n\n  // Construct the forces.\n  const forceNode = d3.forceManyBody();\n  const forceLink = d3.forceLink(links).id(({index: i}) => N[i]);\n  if (nodeStrength !== undefined) forceNode.strength(nodeStrength);\n  if (linkStrength !== undefined) forceLink.strength(linkStrength);\n\n  const simulation = d3.forceSimulation(nodes)\n      .force(\"link\", forceLink)\n      .force(\"charge\", forceNode)\n      .force(\"x\", d3.forceX())\n      .force(\"y\", d3.forceY())\n      .on(\"tick\", ticked)\n      .alphaDecay(0); // Added by me: keepp the chart in perpetual motion\n\n  const svg = d3.create(\"svg\")\n      .attr(\"width\", width)\n      .attr(\"height\", height)\n      .attr(\"viewBox\", [-width / 2, -height / 2, width, height])\n      .attr(\"style\", \"max-width: 100%; height: auto; height: intrinsic;\");\n\n  const link = svg.append(\"g\")\n      .attr(\"stroke\", linkStroke)\n      .attr(\"stroke-opacity\", linkStrokeOpacity)\n      .attr(\"stroke-width\", typeof linkStrokeWidth !== \"function\" ? linkStrokeWidth : null)\n      .attr(\"stroke-linecap\", linkStrokeLinecap)\n    .selectAll(\"line\")\n    .data(links)\n    .join(\"line\");\n\n  if (W) link.attr(\"stroke-width\", ({index: i}) => W[i]);\n\n  const node = svg.append(\"g\")\n      .attr(\"fill\", nodeFill)\n      .attr(\"stroke\", nodeStroke)\n      .attr(\"stroke-opacity\", nodeStrokeOpacity)\n      .attr(\"stroke-width\", nodeStrokeWidth)\n    .selectAll(\"circle\")\n    .data(nodes)\n    .join(\"circle\")\n      .attr(\"r\", nodeRadius)\n      .call(drag(simulation));\n\n  if (G) node.attr(\"fill\", ({index: i}) => color(G[i]));\n  if (T) node.append(\"title\").text(({index: i}) => T[i]);\n\n  // Handle invalidation.\n  if (invalidation != null) invalidation.then(() => simulation.stop());\n\n  function intern(value) {\n    return value !== null && typeof value === \"object\" ? value.valueOf() : value;\n  }\n\n  function ticked() {\n    link\n      .attr(\"x1\", d => d.source.x)\n      .attr(\"y1\", d => d.source.y)\n      .attr(\"x2\", d => d.target.x)\n      .attr(\"y2\", d => d.target.y);\n\n    node\n      .attr(\"cx\", d => d.x)\n      .attr(\"cy\", d => d.y);\n  }\n\n  function drag(simulation) {    \n    function dragstarted(event) {\n      if (!event.active) simulation.alphaTarget(0.3).restart();\n      event.subject.fx = event.subject.x;\n      event.subject.fy = event.subject.y;\n    }\n    \n    function dragged(event) {\n      event.subject.fx = event.x;\n      event.subject.fy = event.y;\n    }\n    \n    function dragended(event) {\n      if (!event.active) simulation.alphaTarget(0);\n      event.subject.fx = null;\n      event.subject.fy = null;\n    }\n    \n    return d3.drag()\n      .on(\"start\", dragstarted)\n      .on(\"drag\", dragged)\n      .on(\"end\", dragended);\n  }\n\n  return Object.assign(svg.node(), {scales: {color}});\n}\n"},{"methodName":"interpretQuiet","source":"shinyInput('highlight_a')"},{"methodName":"interpretQuiet","source":"shinyInput('parlength_max')"},{"methodName":"interpretQuiet","source":"shinyInput('highlight_b')"}]}
</script>
<script type="module">
window._ojs.paths.runtimeToDoc = "../../posts/2023-03-22-literary-analysis";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "../..";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center"><div class="cookie-consent-footer"><a href="#" id="open_preferences_center">Cookie Preferences</a></div></div>
  </div>
</footer>



</body></html>