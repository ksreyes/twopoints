[
  {
    "path": "posts/2022-11-26-migration/",
    "title": "More on the great post-1500 migrations",
    "description": "Which countries have the most diverse ancestors? Which countries have the most descendants around the world today?",
    "author": [],
    "date": "2022-11-26",
    "categories": [],
    "contents": "\r\nIn my last post I brought up the World Migration Matrix, an ambitious dataset constructed in 2009 by Louis Putterman and David N. Weil that attempts to trace the ancestral origins of the present-day populations of nearly every country on Earth. It’s a complete matrix, so that you can pick any pair of countries and obtain the share of one country’s ancestors that originated from the other, and vice versa. It’s a deeply fascinating dataset and I thought I’d play around with it some more. (It’s also a chance to familiarize myself further with Highcharts.)\r\nPreviously, I plotted the immigrant share of each country, i.e. the share of its current population whose ancestors were not living in that country in the year 1500 (using modern borders). A related question to ask is, what is the ancestral diversity of each country? We encountered cases like Taiwan where nearly all inhabitants have “foreign” ancestors, but since a huge portion come from China, its resulting ancestral diversity is quite low. Contrast that with, say, the United States, where both the immigrant share is high and the ancestral country sources are very diverse.\r\nTo quantify this more formally, I use 1 minus the HH index as a measure of ancestral diversity. It takes a bit of data processing so I’m hiding the code below.\r\n\r\n\r\nShow code\r\n\r\nlibrary(tidyverse)\r\nlibrary(readxl)\r\nlibrary(countrycode)\r\n\r\nmm_raw <- read_excel(\"matrix version 1.1.xls\") %>%\r\n  select(-update) %>%\r\n  pivot_longer(cols = !c(wbcode, wbname),\r\n               names_to = \"origin\",\r\n               values_to = \"share\")\r\n\r\n# Convert to ISO names and codes\r\n\r\nmm <- mm_raw %>%\r\n  mutate(origin = toupper(origin),\r\n         country_iso3 = countrycode(wbcode, \"wb\", \"iso3c\"),\r\n         origin_iso3 = countrycode(origin, \"wb\", \"iso3c\"))\r\n\r\nmm$country_iso3[mm$wbcode == \"ZAR\"] <- mm$origin_iso3[mm$origin == \"ZAR\"] <- \"COD\"\r\nmm$country_iso3[mm$wbcode == \"TMP\"] <- mm$origin_iso3[mm$origin == \"TMP\"] <- \"TLS\"\r\nmm$country_iso3[mm$wbcode == \"ROM\"] <- mm$origin_iso3[mm$origin == \"ROM\"] <- \"ROU\"\r\nmm$country_iso3[mm$wbcode == \"OAN\"] <- mm$origin_iso3[mm$origin == \"OAN\"] <- \"TWN\"\r\n\r\nmm <- mm %>%\r\n  mutate(country_name = countrycode(country_iso3, \"iso3c\", \"country.name\"),\r\n         origin_name = countrycode(origin_iso3, \"iso3c\", \"country.name\"),\r\n         country_region = countrycode(country_iso3, \"iso3c\", \"continent\"),\r\n         origin_region = countrycode(origin_iso3, \"iso3c\", \"continent\")) %>%\r\n  select(country_iso3, country_name, country_region, origin_iso3, origin_name, origin_region, share) %>%\r\n  drop_na() \r\n\r\n# Compute immigrant share\r\n\r\nmm_immig <- mm %>%\r\n  filter(country_iso3 == origin_iso3) %>%\r\n  mutate(immig = 1 - share) %>%\r\n  select(country_iso3, country_name, country_region, immig)\r\n\r\n# Compute ancestral diversity\r\n\r\nmm_hhi <- mm %>%\r\n  mutate(share2 = share^2) %>%\r\n  group_by(country_iso3, country_name, country_region) %>%\r\n  summarize(hhi = 1 - sum(share2)) %>%\r\n  ungroup()\r\n\r\nmm_immig_hhi <- mm_immig %>%\r\n  left_join(mm_hhi)\r\n\r\n\r\nThe following scatter plots ancestral diversity against the immigrant share of ancestors. They go hand-in-hand up to a point, and then we encounter enormous variety. I was surprised to find that the country with the most diverse set of ancestors is Jamaica, followed very closely by the United States. The other panels below showcase the ancestral origins of Jamaica and the U.S.\r\n\r\nImmigrant share vs diversity\r\n\r\n\r\nShow code\r\n\r\nlibrary(highcharter)\r\n\r\nx <- c(\"Country\", \"Continent\", \"Immigrant share of ancestors\", \"Ancestral diversity\")\r\ny <- c(\"{point.country_name:s}\", \"{point.country_region:s}\", \"{point.immig:.2f}\", \"{point.hhi:.2f}\")\r\ntltip <- tooltip_table(x, y)\r\n\r\nhchart(mm_immig_hhi, \"scatter\", \r\n       hcaes(x = immig, y = hhi, group = country_region),\r\n       color = c(\"#1046b1\", \"#a835a6\", \"#f0307d\", \"#ff6549\", \"#ffa600\"),\r\n       stickyTracking = FALSE,\r\n       jitter = list(x = .005, y = .005)) %>%\r\n  hc_xAxis(title = list(text = \"Immigrant share of ancestors\"),\r\n           gridLineWidth = 1) %>%\r\n  hc_yAxis(title = list(text = \"Ancestral diversity\"),\r\n           gridLineWidth = 1) %>%\r\n  hc_tooltip(useHTML = TRUE,\r\n             pointFormat = tltip,\r\n             headerFormat = \"\")\r\n\r\n\r\n\r\nJamaica’s ancestors\r\n\r\n\r\nShow code\r\n\r\njamaica <- mm %>%\r\n  filter(country_name == \"Jamaica\")\r\n\r\nformattp <- JS(\"function() {\r\n  if (this.point.value < 0.01) {\r\n    return '<b>' + this.point.name + '<\/b>: <0.01';\r\n  }\r\n  else {\r\n    return '<b>' + this.point.name + '<\/b>: ' + Highcharts.numberFormat(this.point.value, 2);\r\n  }\r\n}\")\r\n\r\nhcmap(map = \"custom/world-highres3\", \r\n      data = jamaica,\r\n      name = \"origin_name\",\r\n      value = \"share\",\r\n      borderWidth = .5,\r\n      joinBy = c(\"iso-a3\", \"origin_iso3\")) %>%\r\n  hc_mapNavigation(enabled = TRUE) %>%\r\n  hc_legend(align = \"left\",\r\n            title = list(text = \"Ancestral contribution to Jamaica's population\")) %>%\r\n  hc_tooltip(headerFormat = \"\",\r\n             formatter = formattp)\r\n\r\n\r\n\r\nAmerica’s ancestors\r\n\r\n\r\nShow code\r\n\r\nusa <- mm %>%\r\n  filter(country_name == \"United States\")\r\n\r\nhcmap(map = \"custom/world-highres3\", \r\n      data = usa,\r\n      name = \"origin_name\",\r\n      value = \"share\",\r\n      borderWidth = .5,\r\n      joinBy = c(\"iso-a3\", \"origin_iso3\")) %>%\r\n  hc_mapNavigation(enabled = TRUE) %>%\r\n  hc_legend(align = \"left\",\r\n            title = list(text = \"Ancestral contribution to U.S. population\")) %>%\r\n  hc_tooltip(headerFormat = \"\",\r\n             formatter = formattp)\r\n\r\n\r\n\r\n\r\nNow let’s flip things around: which countries contributed the most to the immigrant share of populations worldwide? Here are the top 10 in terms of absolute amounts:\r\n\r\n\r\nShow code\r\n\r\nlibrary(WDI)\r\n\r\npop <- WDI(country = \"all\",\r\n          indicator = c(\"pop\" = \"SP.POP.TOTL\"),\r\n          start = 2009,\r\n          end = 2009,) %>% \r\n  as_tibble() %>%\r\n  select(iso3c, pop) %>%\r\n  bind_rows(tibble(iso3c = \"TWN\",\r\n                   pop = 23119772))\r\n\r\nmm_origin <- mm %>%\r\n  left_join(pop, by = c(\"country_iso3\" = \"iso3c\")) %>%\r\n  mutate(absolute = share * pop,\r\n         absolute_out = ifelse(country_iso3 == origin_iso3, 0, share * pop))\r\n\r\nmm_origin_sum <- mm_origin %>%\r\n  group_by(origin_iso3, origin_name, origin_region) %>%\r\n  summarize(share = mean(share),\r\n            absolute = sum(absolute),\r\n            absolute_out = sum(absolute_out)) %>%\r\n  ungroup() %>%\r\n  filter(absolute_out > 0) %>%\r\n  arrange(-absolute_out) %>%\r\n  slice(1:10)\r\n\r\nmm_origin_sum <- mm_origin_sum %>%\r\n  mutate(origin_name = factor(origin_name, levels = mm_origin_sum$origin_name))\r\n\r\nhchart(mm_origin_sum, \"bar\", \r\n       hcaes(y = absolute_out, x = origin_name),\r\n       color = \"#1046b1\",\r\n       stickyTracking = FALSE) %>%\r\n  hc_yAxis(title = list(text = \"Global descendants outside of own country\"),\r\n           gridLineWidth = 1) %>%\r\n  hc_xAxis(title = list(text = \"\")) %>%\r\n  hc_tooltip(useHTML = TRUE,\r\n             pointFormat = \"{point.absolute_out:,.0f}\",\r\n             headerFormat = \"\")\r\n\r\n\r\n\r\nAround the world, some 167 million people1 not living in Spain have ancestors who lived in Spain in the year 1500. It speaks to the legacy of European colonization and migration that the top 5 largest sources of immigrant ancestry are European countries.\r\nWhere did the descendants of these prolific exporters of people settle? Here are some more maps to give you an idea.\r\n\r\nSpain\r\n\r\n\r\nShow code\r\n\r\nlibrary(CoordinateCleaner)\r\n\r\ncentroids <- as_tibble(countryref) %>%\r\n  filter(type == \"country\") %>%\r\n  select(iso3, centroid.lon, centroid.lat) %>%\r\n  group_by(iso3) %>%\r\n  summarize(lon = mean(centroid.lon),\r\n            lat = mean(centroid.lat)) %>%\r\n  ungroup()\r\n\r\nspain <- mm_origin %>%\r\n  filter(origin_name == \"Spain\") %>%\r\n  left_join(centroids, by = c(\"country_iso3\" = \"iso3\")) %>%\r\n  mutate(z = absolute_out)\r\n\r\nhcmap(map = \"custom/world\", \r\n      borderWidth = .5,\r\n      showInLegend = FALSE) %>%\r\n  hc_add_series(data = spain, \r\n                type = \"mapbubble\",\r\n                maxSize = \"40\", \r\n                minSize = \"0\",\r\n                showInLegend = FALSE,\r\n                color = hex_to_rgba(\"#1046b1\", alpha = 0.3),\r\n                tooltip = list(headerFormat = \"\",\r\n                               pointFormat = \"<b>{point.country_name}<\/b>: {point.absolute_out:,.0f}\")) %>%\r\n  hc_title(text = \"Distribution of Spanish descendants\")\r\n\r\n\r\n\r\nPortugal\r\n\r\n\r\nShow code\r\n\r\nportugal <- mm_origin %>%\r\n  filter(origin_name == \"Portugal\") %>%\r\n  left_join(centroids, by = c(\"country_iso3\" = \"iso3\")) %>%\r\n  mutate(z = absolute_out)\r\n\r\nhcmap(map = \"custom/world\", \r\n      borderWidth = .5,\r\n      showInLegend = FALSE) %>%\r\n  hc_add_series(data = portugal, \r\n                type = \"mapbubble\",\r\n                maxSize = \"40\", \r\n                minSize = \"0\",\r\n                showInLegend = FALSE,\r\n                color = hex_to_rgba(\"#1046b1\", alpha = 0.3),\r\n                tooltip = list(headerFormat = \"\",\r\n                               pointFormat = \"<b>{point.country_name}<\/b>: {point.absolute_out:,.0f}\")) %>%\r\n  hc_title(text = \"Distribution of Portuguese descendants\")\r\n\r\n\r\n\r\nUnited Kingdom\r\n\r\n\r\nShow code\r\n\r\nuk <- mm_origin %>%\r\n  filter(origin_name == \"United Kingdom\") %>%\r\n  left_join(centroids, by = c(\"country_iso3\" = \"iso3\")) %>%\r\n  mutate(z = absolute_out)\r\n\r\nhcmap(map = \"custom/world\", \r\n      borderWidth = .5,\r\n      showInLegend = FALSE) %>%\r\n  hc_add_series(data = uk, \r\n                type = \"mapbubble\",\r\n                maxSize = \"40\", \r\n                minSize = \"0\",\r\n                showInLegend = FALSE,\r\n                color = hex_to_rgba(\"#1046b1\", alpha = 0.3),\r\n                tooltip = list(headerFormat = \"\",\r\n                               pointFormat = \"<b>{point.country_name}<\/b>: {point.absolute_out:,.0f}\")) %>%\r\n  hc_title(text = \"Distribution of British descendants\")\r\n\r\n\r\n\r\nChina\r\n\r\n\r\nShow code\r\n\r\nchina <- mm_origin %>%\r\n  filter(origin_name == \"China\") %>%\r\n  left_join(centroids, by = c(\"country_iso3\" = \"iso3\")) %>%\r\n  mutate(z = absolute_out)\r\n\r\nhcmap(map = \"custom/world\", \r\n      borderWidth = .5,\r\n      showInLegend = FALSE) %>%\r\n  hc_add_series(data = china, \r\n                type = \"mapbubble\",\r\n                maxSize = \"40\", \r\n                minSize = \"0\",\r\n                showInLegend = FALSE,\r\n                color = hex_to_rgba(\"#1046b1\", alpha = 0.3),\r\n                tooltip = list(headerFormat = \"\",\r\n                               pointFormat = \"<b>{point.country_name}<\/b>: {point.absolute_out:,.0f}\")) %>%\r\n  hc_title(text = \"Distribution of Chinese descendants\")\r\n\r\n\r\n\r\nIndia\r\n\r\n\r\nShow code\r\n\r\nindia <- mm_origin %>%\r\n  filter(origin_name == \"India\") %>%\r\n  left_join(centroids, by = c(\"country_iso3\" = \"iso3\")) %>%\r\n  mutate(z = absolute_out)\r\n\r\nhcmap(map = \"custom/world\", \r\n      borderWidth = .5,\r\n      showInLegend = FALSE) %>%\r\n  hc_add_series(data = india, \r\n                type = \"mapbubble\",\r\n                maxSize = \"40\", \r\n                minSize = \"0\",\r\n                showInLegend = FALSE,\r\n                color = hex_to_rgba(\"#1046b1\", alpha = 0.3),\r\n                tooltip = list(headerFormat = \"\",\r\n                               pointFormat = \"<b>{point.country_name}<\/b>: {point.absolute_out:,.0f}\")) %>%\r\n  hc_title(text = \"Distribution of Indian descendants\")\r\n\r\n\r\n\r\nAngola\r\n\r\n\r\nShow code\r\n\r\nangola <- mm_origin %>%\r\n  filter(origin_name == \"Angola\") %>%\r\n  left_join(centroids, by = c(\"country_iso3\" = \"iso3\")) %>%\r\n  mutate(z = absolute_out)\r\n\r\nhcmap(map = \"custom/world\", \r\n      borderWidth = .5,\r\n      showInLegend = FALSE) %>%\r\n  hc_add_series(data = angola, \r\n                type = \"mapbubble\",\r\n                maxSize = \"40\", \r\n                minSize = \"0\",\r\n                showInLegend = FALSE,\r\n                color = hex_to_rgba(\"#1046b1\", alpha = 0.3),\r\n                tooltip = list(headerFormat = \"\",\r\n                               pointFormat = \"<b>{point.country_name}<\/b>: {point.absolute_out:,.0f}\")) %>%\r\n  hc_title(text = \"Distribution of Angolan descendants\")\r\n\r\n\r\n\r\n\r\n\r\nNot meant to be literal since a person can be of mixed ancestry. Perhaps it is more proper to say there are 167 million “people-equivalent” whose ancestors came from Spain. But hey, we’re just having fun here!↩︎\r\n",
    "preview": "posts/2022-11-26-migration/immigrant.jpg",
    "last_modified": "2022-11-28T22:41:19+08:00",
    "input_file": {}
  },
  {
    "path": "posts/2022-11-25-roots/",
    "title": "The roots of economic development",
    "description": "Visualizing some key results in Spolaore and Wacziarg's 2013 survey",
    "author": [],
    "date": "2022-11-25",
    "categories": [],
    "contents": "\r\nOne of the most interesting economics papers I’ve ever read is the 2013 survey by Enrico Spolaore and Romain Wacziarg (SW) titled “How Deep Are the Roots of Economic Development?” There has long been an active, highly contentious discussion over why some countries today are rich while others are poor. As a citizen of a “poor” country, this was a big motivation for me to study economics.1\r\nThe proximate causes are relatively uncontroversial—Solow had it all laid out in 1956. Production turns inputs into output. More inputs mean more output. Some output are consumed, some are saved (“invested”) and turned into capital, which are then used as inputs to produce more output. You can keep accumulating capital to grow your output, but over time, for a given state of technology, capital accumulation will hit diminishing returns. You will then need to move up the technological ladder to continue increasing output. Repeat until rich.\r\nThe Solow model is elegant, but it has the flavor of saying that a business is successful because it makes a lot of money. The deeper question is why some countries have managed to perform these pro-growth activities while others have not. Is it something in their culture? Maybe their geography? Maybe they had a Great Leader who put all the pieces in place?\r\nThis has been the research agenda of a number of empirical economic historians. Their work supplements that of traditional economic historians by quantifying the evidence for various hypothesized root causes of development. SW survey their findings as of 2013 using a unified dataset available here. What I want to do is chart some of the more interesting results.\r\n\r\n\r\nlibrary(tidyverse)\r\nlibrary(foreign)\r\n\r\ndf <- read.dta(\"2013_longterm.dta\") %>%\r\n  as_tibble()\r\n\r\n\r\nGeography is a natural candidate for explaining the relative wealth of nations. Ever notice that cold countries tend to be richer than hot ones? In fact, it’s empirically well-founded:\r\n\r\n\r\nShow code\r\n\r\nlibrary(highcharter)\r\nlibrary(broom)\r\n\r\npretty <- function(n, d = 0) {\r\n  n <- format( round(n, digits = d), nsmall = d )\r\n  prettyNum(n, big.mark = \",\", scientific = FALSE)\r\n}\r\n\r\ndf1 <- df %>%\r\n  select(country, rgdpch_2005, avelat) %>%\r\n  drop_na() %>%\r\n  mutate(rgdpch_2005_pretty = pretty(rgdpch_2005, 0))\r\n\r\nfit <- lm(log10(rgdpch_2005) ~ avelat, data = df1) %>%\r\n  augment() %>%\r\n  arrange(avelat) %>%\r\n  slice(c(1, nrow(df1)))\r\n\r\nx <- c(\"Country\", \"GDP per capita\", \"Absolute latitude\")\r\ny <- c(\"{point.country:s}\", \"${point.rgdpch_2005_pretty:s}\", \"{point.avelat:.1f}\")\r\ntltip <- tooltip_table(x, y)\r\n\r\nhchart(df1, \"scatter\", \r\n       hcaes(x = avelat, y = rgdpch_2005),\r\n       color = hex_to_rgba(\"#1046b1\", 0.5),\r\n       size = 20,\r\n       stickyTracking = FALSE) %>%\r\n  hc_xAxis(title = list(text = \"Absolute latitude\"),\r\n           gridLineWidth = 1) %>%\r\n  hc_yAxis(title = list(text = \"GDP per capita 2005\"),\r\n           type = \"logarithmic\", \r\n           gridLineWidth = 1) %>%\r\n  hc_tooltip(useHTML = TRUE,\r\n             pointFormat = tltip,\r\n             headerFormat = \"\") %>%\r\n  hc_add_series(data = fit, \r\n                type = \"spline\",\r\n                hcaes(x = avelat, y = 10^.fitted),\r\n                color = \"black\",\r\n                lineWidth = 1,\r\n                marker = FALSE,\r\n                enableMouseTracking = FALSE)\r\n\r\n\r\n\r\nWhat explains this intriguing correlation? SW divide proposed mechanisms into direct and indirect channels. Geography may have a direct influence on economic development through the effects of climate and diseases on agricultural and labor productivity. Or in cruder form, this is the argument that hotter weather makes for lazier people, which Rizal refuted in “The Indolence of the Filipino”.\r\nArguments for an indirect channel are, for me, more convincing. Geography influenced x, and x in turn influenced economic development. There may even be additional layers (x influenced y, y influenced z, etc.). A famous hypothesis comes from Jared Diamond’s 1997 book Guns, Germs, and Steel, which argues that climate and the ecosystems it supported influenced the onset of agriculture and domestication in a society, what is known as the Neolithic Revolution. In turn, societies that transitioned earlier would have had a head start in technological progress and centralized governments. This explains why Europeans had the advantage of “guns, germs, and steel” as they were conquering the civilizations of New World America in the 16th century.\r\nTo illustrate the Diamond hypothesis, the following plots population density in the year 1500 against the years since a country had undergone its Neolithic Revolution—population density being the best proxy available for relative economic development in a pre-industrial world. Again, a positive correlation is established.\r\n\r\n\r\nShow code\r\n\r\ndf1 <- df %>%\r\n  select(country, pd1500, agyears) %>%\r\n  drop_na() %>%\r\n  mutate(pd1500_pretty = pretty(pd1500, 2),\r\n         agyears_pretty = pretty(agyears, 0))\r\n\r\nfit <- lm(log10(pd1500) ~ agyears, data = df1) %>%\r\n  augment() %>%\r\n  arrange(agyears) %>%\r\n  slice(c(1, nrow(df1)))\r\n\r\nx <- c(\"Country\", \"Population density in 1500\", \"Years since Neolithic Revolution\")\r\ny <- c(\"{point.country:s}\", \"{point.pd1500_pretty:s}\", \"{point.agyears_pretty:s}\")\r\ntltip <- tooltip_table(x, y)\r\n\r\nhchart(df1, \"scatter\", \r\n       hcaes(x = agyears, y = pd1500),\r\n       color = hex_to_rgba(\"#1046b1\", 0.5),\r\n       size = 20,\r\n       stickyTracking = FALSE) %>%\r\n  hc_xAxis(title = list(text = \"Years since Neolithic Revolution\"),\r\n           gridLineWidth = 1) %>%\r\n  hc_yAxis(title = list(text = \"Population density 1500\"),\r\n           type = \"logarithmic\", \r\n           gridLineWidth = 1) %>%\r\n  hc_tooltip(useHTML = TRUE,\r\n             pointFormat = tltip,\r\n             headerFormat = \"\") %>%\r\n  hc_add_series(data = fit, \r\n                type = \"spline\",\r\n                hcaes(x = agyears, y = 10^.fitted),\r\n                color = \"black\",\r\n                lineWidth = 1,\r\n                marker = FALSE,\r\n                enableMouseTracking = FALSE)\r\n\r\n\r\n\r\nThere is another reason why it makes more sense to use economic development as of 1500 rather than as of today. If geography shapes economic destinies, then how do we account for countries whose peoples are, in the grand scale of things, relative newcomers to the environments they now inhabit? These include European migrants to the New World as well as African slaves forcibly transported to New World colonies. If it takes thousands of years for geography to shape human cultures and institutions, then an English colonist who settled in what is now the United States would have been influenced by English rather than American geography.\r\nIn short, one must take into account the historical composition of a given country’s population when correlating geographic factors to contemporary development. This motivates the World Migration Matrix constructed by Louis Putterman and David N. Weil, which, for 165 countries, gives “an estimate of the proportion of the ancestors in 1500 of that country’s population today that were living within what are now the borders of that and each of the other countries”. To take one example, among the present-day inhabitants of Cuba, Putterman and Weil estimate that 63% of their ancestors originate from Spain, 5.6% from Nigeria, 5.1% from Ghana, 4.9% from Angola, and so on. Cuba today would exhibit the effects of the weighted average of all these different geographies.\r\nThe following map shows the countries with the highest proportion of “immigrants” relative to their present-day populations. In countries like Australia, Singapore, Taiwan, and Jamaica, very few of their current citizens have ancestors that were living in that country in 1500. On the opposite extreme are countries like China, Japan, Algeria, and Greece.\r\n\r\n\r\nShow code\r\n\r\nlibrary(readxl)\r\nlibrary(countrycode)\r\n\r\nmm <- read_excel(\"matrix version 1.1.xls\") %>%\r\n  pivot_longer(cols = !c(wbcode, wbname),\r\n               names_to = \"ancestry\",\r\n               values_to = \"share\") %>%\r\n  mutate(ancestry = toupper(ancestry)) %>%\r\n  filter(wbcode == ancestry) %>%\r\n  mutate(immigrant = 1 - share,\r\n         iso_3 = countrycode(wbcode, \"wb\", \"iso3c\")) %>%\r\n  select(iso_3, wbname, immigrant)\r\n\r\nmm$iso_3[mm$wbname == \"Congo, Dem. Rep.\"] <- \"COD\"\r\nmm$iso_3[mm$wbname == \"East Timor\"] <- \"TLS\"\r\nmm$iso_3[mm$wbname == \"Romania\"] <- \"ROU\"\r\nmm$iso_3[mm$wbname == \"Taiwan, China\"] <- \"TWN\"\r\n\r\nformattp <- JS(\"function() {\r\n  if (this.point.value < 0.01) {\r\n    return '<b>' + this.point.name + '<\/b>: <0.01';\r\n  }\r\n  else {\r\n    if (this.point.value > 0.99) {\r\n      return '<b>' + this.point.name + '<\/b>: >0.99';\r\n    }\r\n    else {\r\n      return '<b>' + this.point.name + '<\/b>: ' + Highcharts.numberFormat(this.point.value, 2);\r\n    }\r\n  }\r\n}\")\r\n\r\nhcmap(map = \"custom/world-highres3\", \r\n      data = mm,\r\n      name = \"Share of population that arrived after 1500\",\r\n      value = \"immigrant\",\r\n      borderWidth = .5,\r\n      joinBy = c(\"iso-a3\", \"iso_3\")) %>%\r\n  hc_legend(align = \"left\",\r\n            title = list(text = \"Share of population that arrived after 1500\")) %>%\r\n  hc_mapNavigation(enabled = TRUE) %>%\r\n  hc_tooltip(headerFormat = \"\",\r\n             formatter = formattp)\r\n\r\n\r\n\r\nApplying an “ancestry adjustment” to the Diamond hypothesis makes a significant difference. The first chart below plots GDP per capita today and the years since the Neolithic Revolution. There is a positive correlation, albeit a weak one. The second chart plots GDP per capita against the ancestry-adjusted years since the Neolithic Revolution. Doing this strengthens the correlation. This suggests that (1) people were shaped by their environment, and (2) they brought their cultures and institutions with them during the great post-1500 migrations.\r\n\r\nUnadjusted\r\n\r\n\r\nShow code\r\n\r\ndf1 <- df  %>%\r\n  select(country, rgdpch_2005, agyears) %>%\r\n  drop_na() %>%\r\n  mutate(rgdpch_2005_pretty = pretty(rgdpch_2005, 0),\r\n         agyears_pretty = pretty(agyears, 0))\r\n\r\nfit <- lm(log10(rgdpch_2005) ~ agyears, data = df1) %>%\r\n  augment() %>%\r\n  arrange(agyears) %>%\r\n  slice(c(1, nrow(df1)))\r\n\r\nx <- c(\"Country\", \"GDP per capita\", \"Years since Neolithic Revolution\")\r\ny <- c(\"{point.country:s}\", \"${point.rgdpch_2005_pretty:s}\", \"{point.agyears_pretty:s}\")\r\ntltip <- tooltip_table(x, y)\r\n\r\nhchart(df1, \"scatter\", \r\n       hcaes(x = agyears, y = rgdpch_2005),\r\n       color = hex_to_rgba(\"#1046b1\", 0.5),\r\n       size = 20,\r\n       stickyTracking = FALSE) %>%\r\n  hc_xAxis(title = list(text = \"Years since Neolithic Revolution\"),\r\n           gridLineWidth = 1,\r\n           min = 0, max = 11000) %>%\r\n  hc_yAxis(title = list(text = \"GDP per capita 2005\"),\r\n           type = \"logarithmic\", \r\n           gridLineWidth = 1) %>%\r\n  hc_tooltip(useHTML = TRUE,\r\n             pointFormat = tltip,\r\n             headerFormat = \"\") %>%\r\n  hc_add_series(data = fit, \r\n                type = \"spline\",\r\n                hcaes(x = agyears, y = 10^.fitted),\r\n                color = \"black\",\r\n                lineWidth = 1,\r\n                marker = FALSE,\r\n                enableMouseTracking = FALSE)\r\n\r\n\r\n\r\nAncestry-adjusted\r\n\r\n\r\nShow code\r\n\r\ndf1 <- df  %>%\r\n  select(country, rgdpch_2005, adjagyears) %>%\r\n  drop_na() %>%\r\n  mutate(rgdpch_2005_pretty = pretty(rgdpch_2005, 0),\r\n         adjagyears_pretty = pretty(adjagyears, 0))\r\n\r\nfit <- lm(log10(rgdpch_2005) ~ adjagyears, data = df1) %>%\r\n  augment() %>%\r\n  arrange(adjagyears) %>%\r\n  slice(c(1, nrow(df1)))\r\n\r\nx <- c(\"Country\", \"GDP per capita\", \"Years since Neolithic Revolution\")\r\ny <- c(\"{point.country:s}\", \"${point.rgdpch_2005_pretty:s}\", \"{point.adjagyears_pretty:s}\")\r\ntltip <- tooltip_table(x, y)\r\n\r\nhchart(df1, \"scatter\", \r\n       hcaes(x = adjagyears, y = rgdpch_2005),\r\n       color = hex_to_rgba(\"#1046b1\", 0.5),\r\n       size = 20,\r\n       stickyTracking = FALSE) %>%\r\n  hc_xAxis(title = list(text = \"Years since Neolithic Revolution (ancestry-adjusted)\"),\r\n           gridLineWidth = 1,\r\n           min = 0, max = 11000) %>%\r\n  hc_yAxis(title = list(text = \"GDP per capita 2005\"),\r\n           type = \"logarithmic\", \r\n           gridLineWidth = 1) %>%\r\n  hc_tooltip(useHTML = TRUE,\r\n             pointFormat = tltip,\r\n             headerFormat = \"\") %>%\r\n  hc_add_series(data = fit, \r\n                type = \"spline\",\r\n                hcaes(x = adjagyears, y = 10^.fitted),\r\n                color = \"black\",\r\n                lineWidth = 1,\r\n                marker = FALSE,\r\n                enableMouseTracking = FALSE)\r\n\r\n\r\n\r\n\r\nThe correlations above provide pretty fascinating insights. But they are all flawed, of course. Countries are not random realizations of a well-defined stochastic process. Nor are they equal: when generalizing about long-run economic development, it’s not clear that the experiences of a Singapore or a Cape Verde should hold equal weight to the experiences of an India or a China. Which are the exceptions and which are the rules? Do rules even exist?\r\nThe field of empirical economic history has done much to extend, refine, and qualify the basic results shown here. Hopefully I’ll write about them in future posts.\r\n\r\nTen years later and I still don’t have clear answers.↩︎\r\n",
    "preview": "posts/2022-11-25-roots/ancestry.jpg",
    "last_modified": "2022-11-28T22:44:21+08:00",
    "input_file": {}
  },
  {
    "path": "posts/2022-11-19-the-emotional-shape-of-novels/",
    "title": "The emotional shape of novels",
    "description": "Using sentiment analysis, I chart the emotional highs and lows of three classic novels",
    "author": [],
    "date": "2022-11-19",
    "categories": [],
    "contents": "\r\nNovels can take you for such a ride.\r\nToday I’m experimenting with sentiment analysis on some novels I’ve recently read. I’ll be using tidytext with data from gutenbergr (i.e. Project Gutenberg), which means I’m restricted to the classics. I read three this year: Swann’s Way by Marcel Proust, Tess of the d’Urbervilles by Thomas Hardy, and The Age of Innocence by Edith Wharton.\r\nQuick review of each. (1) It takes a certain mood to be reading Proust. I got through Within a Budding Grove but found halfway through that oops I’m not in the mood anymore, so I stopped searching for that lost time. (2) While I enjoyed Hardy’s Far from the Madding Crowd, Tess was such an unrelenting depression parade that I was feeling numb by the end of it. (3) Ah, Age of Innocence is one of my all-time favorites. I have been, at various points in my life, Newland, Ellen, and May. My God, I might have even been a Julius Beaufort.\r\nLet’s load up these works.\r\n\r\n\r\nlibrary(tidyverse)\r\nlibrary(tidytext)\r\nlibrary(gutenbergr)\r\n\r\n# Get the IDs\r\ngutenberg_works(title %in% c(\"Swann's Way\", \r\n                             \"Tess of the d'Urbervilles: A Pure Woman\", \r\n                             \"The Age of Innocence\"))\r\n\r\n# A tibble: 3 × 8\r\n  gutenberg_id title     author guten…¹ langu…² guten…³ rights has_t…⁴\r\n         <int> <chr>     <chr>    <int> <chr>   <chr>   <chr>  <lgl>  \r\n1          110 Tess of … Hardy…      23 en      Banned… Publi… TRUE   \r\n2          541 The Age … Whart…     104 en      Movie … Publi… TRUE   \r\n3         7178 Swann's … Prous…     987 en      <NA>    Publi… TRUE   \r\n# … with abbreviated variable names ¹​gutenberg_author_id, ²​language,\r\n#   ³​gutenberg_bookshelf, ⁴​has_text\r\n\r\nbooks <- gutenberg_download(c(110, 541, 7178)) %>%\r\n  filter(text != \"\") %>%\r\n  group_by(gutenberg_id) %>%\r\n  mutate(line = row_number()) %>%\r\n  ungroup() %>%\r\n  left_join(tibble(gutenberg_id = c(110, 541, 7178),\r\n                   title = c(\"Tess of the d'Urbervilles\", \r\n                             \"The Age of Innocence\", \r\n                             \"Swann's Way\"))) %>%\r\n  select(title, line, text)\r\n\r\n\r\nLines refer to lines on the printed page. What I want to do is split each work into 100 equal sized groups of lines, quantify the sentiment of each, and map the emotional shape of the novel. I’m using the AFINN lexicon, which assigns a score between -5 and 5 to about 2500 English words. More negative scores imply more negative sentiments, and vice nersa.\r\nThe following code breaks up the works so that each row corresponds to one word. Uninteresting words like “the” are removed with anti_join(stop_words). The remaining words are then assigned a sentiment score according to AFINN.\r\n\r\n\r\nbooks_df <- books %>%\r\n  unnest_tokens(word, text) %>%\r\n  anti_join(stop_words) %>%\r\n  inner_join(get_sentiments(\"afinn\"))\r\n\r\n\r\nLet’s try it out first with Tess. It has 13,776 lines, so I split it into 100 chunks of 138 lines.\r\n\r\n\r\n\r\nIt worked! But the chart is ugly! The problem is that net sentiment swings so wildly up and down from chunk to chunk that the result looks more like a seismograph than the “shape” of the novel.\r\nLet’s try a different approach. When you read a chapter and it’s a happy one, you enter the next chapter starting from a position of positive sentiment. Then maybe the next chapter is a sad one, so it brings down your overall sentiment back to something like neutral. The point is, the emotional weight of a novel builds, it doesn’t reset every chapter. Working off this idea, let’s try and map cumulative sentiment across the novel instead of the isolated sentiment of each chunk.\r\nThe chart that works best for this is a waterfall chart, for which the waterfalls package will be helpful.\r\n\r\n\r\nlibrary(waterfalls)\r\n\r\ntess <- tess %>%\r\n  mutate(chunk = factor(chunk),\r\n         fill = ifelse(sentiment >= 0, \"#1046b1\", \"#d1241a\"))\r\n\r\nwf <- waterfall(tess, \r\n                rect_width = 1, \r\n                rect_border = NA, \r\n                rect_text_labels = rep(NA, nrow(tess)),\r\n                draw_axis.x = \"none\",\r\n                fill_by_sign = FALSE, \r\n                fill_colours = tess$fill) + \r\n  geom_hline(yintercept = 0, color = \"gray50\", size = .25, linetype = \"dashed\") + \r\n  scale_y_continuous(name = \"Sentiment (AFINN lexicon)\") + \r\n  theme(axis.title = element_blank(),\r\n        axis.title.x = element_blank(),\r\n        axis.title.y = element_text(size = 12, margin = margin(0, 10, 0, 0)),\r\n        axis.text.x = element_blank(),\r\n        axis.text.y = element_text(size = 11),\r\n        axis.ticks = element_blank(),\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid.major = element_blank(),\r\n        panel.grid.minor = element_blank())\r\nwf\r\n\r\n\r\n\r\nNow the shape is more discernible. You can see the ups and downs of Tess’ life (it’s mostly downs). By the end of the book, you are at about a -600 sentiment score.\r\nFor a bit of extra fanciness let’s annotate the chart with the book’s title, author, and cover, the last one taken from Goodreads.\r\n\r\n\r\nlibrary(cowplot)\r\nlibrary(magick)\r\n\r\nggdraw(wf) + \r\n  draw_image(\"https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1543250144l/42959097._SY475_.jpg\",\r\n             x = .16, y = .1, halign = 0, valign = 0, scale = .4) + \r\n  draw_label(\"Tess of the d'Urbervilles\",\r\n             x = .3, y = .29, hjust = 0, vjust = .5, size = 12, fontface = \"bold\") + \r\n  draw_label(\"by Thomas Hardy\",\r\n             x = .3, y = .23, hjust = 0, vjust = .5, size = 10)\r\n\r\n\r\n\r\nLet’s do the same for The Age of Innocence.\r\n\r\n\r\nShow code\r\n\r\nage <- books_df %>%\r\n  filter(title == \"The Age of Innocence\") %>%\r\n  group_by(chunk = line %/% 94) %>% \r\n  summarise(sentiment = sum(value)) %>%\r\n  mutate(chunk = factor(chunk),\r\n         fill = ifelse(sentiment >= 0, \"#1046b1\", \"#d1241a\"))\r\n\r\nwf <- waterfall(age, \r\n                rect_width = 1, \r\n                rect_border = NA, \r\n                rect_text_labels = rep(NA, nrow(age)),\r\n                draw_axis.x = \"none\",\r\n                fill_by_sign = FALSE, \r\n                fill_colours = age$fill) + \r\n  geom_hline(yintercept = 0, color = \"gray50\", size = .25, linetype = \"dashed\") + \r\n  scale_y_continuous(name = \"Sentiment (AFINN lexicon)\") + \r\n  theme(axis.title = element_blank(),\r\n        axis.title.x = element_blank(),\r\n        axis.title.y = element_text(size = 12, margin = margin(0, 10, 0, 0)),\r\n        axis.text.x = element_blank(),\r\n        axis.text.y = element_text(size = 11),\r\n        axis.ticks = element_blank(),\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid.major = element_blank(),\r\n        panel.grid.minor = element_blank())\r\n\r\nggdraw(wf) + \r\n  draw_image(\"https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1320402548l/545294.jpg\",\r\n             x = .45, y = .18, halign = 0, valign = 0, scale = .4) + \r\n  draw_label(\"The Age of Innocence\",\r\n             x = .45 + .14, y = .18 + .19, hjust = 0, vjust = .5, size = 12, fontface = \"bold\") + \r\n  draw_label(\"by Edith Wharton\",\r\n             x = .45 + .14, y = .18 + .13, hjust = 0, vjust = .5, size = 10)\r\n\r\n\r\n\r\nIt’s a reasonably happy ride for the first half of the novel as we follow Madame Olenska’s disruptions of the self-satisfied New York upper-class society of the 19th century. The turning point is right about where Newland Archer decides not to call her from up the hill. There’s a steady descent as passions clash with idealistic notions of the world before ending on a bittersweet note. You end the book on a net positive, and all in all I’d say that makes sense.\r\nFinally, here is Swann’s Way.\r\n\r\n\r\nShow code\r\n\r\nswann <- books_df %>%\r\n  filter(title == \"Swann's Way\") %>%\r\n  group_by(chunk = line %/% 159) %>% \r\n  summarise(sentiment = sum(value)) %>%\r\n  mutate(chunk = factor(chunk),\r\n         fill = ifelse(sentiment >= 0, \"#1046b1\", \"#d1241a\"))\r\n\r\nwf <- waterfall(swann, \r\n                rect_width = 1, \r\n                rect_border = NA, \r\n                rect_text_labels = rep(NA, nrow(swann)),\r\n                draw_axis.x = \"none\",\r\n                fill_by_sign = FALSE, \r\n                fill_colours = swann$fill) + \r\n  geom_hline(yintercept = 0, color = \"gray50\", size = .25, linetype = \"dashed\") + \r\n  scale_y_continuous(name = \"Sentiment (AFINN lexicon)\") + \r\n  theme(axis.title = element_blank(),\r\n        axis.title.x = element_blank(),\r\n        axis.title.y = element_text(size = 12, margin = margin(0, 10, 0, 0)),\r\n        axis.text.x = element_blank(),\r\n        axis.text.y = element_text(size = 11),\r\n        axis.ticks = element_blank(),\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid.major = element_blank(),\r\n        panel.grid.minor = element_blank())\r\n\r\nggdraw(wf) + \r\n  draw_image(\"https://i.gr-assets.com/images/S/compressed.photo.goodreads.com/books/1657565006l/133539._SY475_.jpg\",\r\n             x = .16, y = .3, halign = 0, valign = 0, scale = .4) + \r\n  draw_label(\"Swann's Way\",\r\n             x = .16 + .14, y = .3 + .19, hjust = 0, vjust = .5, size = 12, fontface = \"bold\") + \r\n  draw_label(\"by Marcel Proust\",\r\n             x = .16 + .14, y = .3 + .13, hjust = 0, vjust = .5, size = 10)\r\n\r\n\r\n\r\nThis one surprised me. Odette’s unending torment of Swann didn’t strike me as particularly happy? I guess this demonstrates the limitations of literal-minded approaches to coding sentiments. If the work is heavy on irony, a word-based lexicon like AFINN wouldn’t really be able to catch that.\r\n\r\n\r\n\r\n",
    "preview": "posts/2022-11-19-the-emotional-shape-of-novels/shape-of-novels_files/figure-html5/unnamed-chunk-6-1.png",
    "last_modified": "2022-11-28T22:19:38+08:00",
    "input_file": {},
    "preview_width": 1440,
    "preview_height": 672
  },
  {
    "path": "posts/2022-11-15-ftx/",
    "title": "That FTX balance sheet",
    "description": "SBF shops around for investors with a balance sheet that is emphatically not GAAP",
    "author": [],
    "date": "2022-11-15",
    "categories": [],
    "contents": "\r\nI was reading Matt Levine’s entertaining walkthrough of the FTX balance sheet and I thought it’d be fun to visualize this, um, unique financial document. FTX is a crypto exchange that collapsed spectacularly last week. There are already plans for a movie adaptation and I hope Sorkin and Fincher reunite for it.\r\nThe balance sheet in question is dated 10 November and appears to have been constructed by SBF himself. It sent prospective investors running the other way. Per Levine: “It’s an Excel file full of the howling of ghosts and the shrieking of tortured souls. If you look too long at that spreadsheet, you will go insane.”\r\nFor this visualization, I want to show the assets and liabilities in two bars, with the assets bar broken down into the various weird things that FTX counted as assets. I will be employing a lot of visual trickery in this chart and I’d like to walk you through my process.\r\nFirst, here is how I gathered the numbers into a dataset. Doing it in this “long” format makes it easier to chart.\r\n\r\n\r\nlibrary(tidyverse)\r\n\r\ndf <- read_csv(\"ftx.csv\")\r\ndf\r\n\r\n# A tibble: 12 × 3\r\n   group1      group2            billions\r\n   <chr>       <chr>                <dbl>\r\n 1 liabilities total                8.86 \r\n 2 assets      total                9.58 \r\n 3 assets      liquid               0.900\r\n 4 assets      liquid-robinhood     0.472\r\n 5 assets      liquid-others        0.428\r\n 6 assets      lessliquid           5.45 \r\n 7 assets      lessliquid-ftt       0.554\r\n 8 assets      lessliquid-serum     2.19 \r\n 9 assets      lessliquid-sol       0.982\r\n10 assets      lessliquid-maps      0.616\r\n11 assets      lessliquid-others    1.11 \r\n12 assets      illiquid             3.23 \r\n\r\nHere’s a first stab:\r\n\r\n\r\nlibrary(ggplot2)\r\n\r\ndf1 <- df %>%\r\n  filter(group2 %in% c(\"total\", \"liquid\", \"lessliquid\", \"illiquid\"), !(group1 == \"assets\" & group2 == \"total\"))\r\n  \r\nggplot(df1, aes(x = group1, y = billions, fill = group2)) + \r\n  geom_bar(stat = \"identity\", position = \"stack\") + \r\n  theme(axis.title = element_blank(),\r\n        axis.text.x = element_text(size = 11),\r\n        axis.text.y = element_blank(),\r\n        axis.ticks = element_blank(),\r\n        panel.background = element_blank(),\r\n        panel.grid = element_blank())\r\n\r\n\r\n\r\nAtrocious but you get the idea.\r\nI’m going to annotate these bars with subcategories of interest, so I’ll need some space on the sides. To get this, I’ll add phantom categories to the “group1” column.\r\n\r\n\r\ndf1 <- df1 %>%\r\n  bind_rows(tibble(group1 = c(\"space_l\", \"space_r\"), group2 = \"total\", value = 0)) %>%\r\n  mutate(group1 = factor(group1, levels = c(\"space_l\", \"assets\", \"liabilities\", \"space_r\")))\r\n\r\nplot <- ggplot(df1, aes(x = group1, y = billions, fill = group2)) + \r\n  geom_bar(stat = \"identity\", position = \"stack\", width = .7) + \r\n  theme(axis.title = element_blank(),\r\n        axis.text.x = element_text(size = 11),\r\n        axis.text.y = element_blank(),\r\n        axis.ticks = element_blank(),\r\n        panel.background = element_blank(),\r\n        panel.grid = element_blank())\r\nplot\r\n\r\n\r\n\r\nFor the annotations, we will be using geom_rect(), geom_segment(), annotate(), and a significant amount of trial and error. Let me demonstrate by annotating the portion of the “less liquid” assets that comprise the stuff FTX “made up” (FTT, SRM, SOL, and MAPS tokens). We’ll first need to identify some coordinates in the plot space:\r\n\r\n\r\nh1 <- df$billions[df$group2 == \"liquid\"]\r\nh2 <- h1 + df$billions[df$group2 == \"lessliquid\"]\r\nh3 <- h1 + df$billions[df$group2 == \"lessliquid-others\"]\r\nh4 <- df$billions[df$group1 == \"assets\" & df$group2 == \"total\"]\r\n\r\n\r\nNow we add to the plot:\r\n\r\n\r\nbw <- .35\r\n\r\nplot + \r\n  geom_rect(xmin = 2 - bw, xmax = 2 + bw, ymin = h3, ymax = h2, data = df1[1, ], fill = NA, color = \"black\") + \r\n  geom_segment(x = 2 - bw, xend = 2 - 1.5 * bw, y = h2 - 1, yend = h2 - .8, size = .5, color = \"black\") +\r\n  annotate(\"text\", x = 2 - 2.4 * bw, y = h2 - .75, label = \"Stuff we\\nmade up\", size = 4, hjust = .5)\r\n\r\n\r\n\r\nNote that all the positioning values were discovered through trial and error. So if you’re doing something like this, try and organize your values around fundamental constants of the chart. For example, bw here is half the width of the bars.\r\nNow let’s add all the other annotations, and while we’re at it let’s tweak the aesthetics of the chart. There’s also the question of where to place the 8-billion-dollar “hidden, poorly internally labeled ‘fiat@’ account”. No one’s really sure what to do with this. Writes Matt Levine:\r\n\r\nIf you try to calculate the equity of a balance sheet with an entry for HIDDEN POORLY INTERNALLY LABELED ACCOUNT, Microsoft Clippy will appear before you in the flesh, bloodshot and staggering, with a knife in his little paper-clip hand, saying “just what do you think you’re doing Dave?” You cannot apply ordinary arithmetic to numbers in a cell labeled “HIDDEN POORLY INTERNALLY LABELED ACCOUNT.” The result of adding or subtracting those numbers with ordinary numbers is not a number; it is prison.\r\n\r\nGiven this expert advice, I’ve decided to give it its own accurately sized bar that kind of just hovers over the liabilities bar, like a ghoul.\r\nHere’s the final chart:\r\n\r\n\r\nShow code\r\n\r\nggplot(df1, aes(x = group1, y = billions, fill = group2)) + \r\n  geom_bar(stat = \"identity\", position = \"stack\", width = .7) + \r\n  \r\n  # Hidden poorly internally labeled account\r\n  geom_rect(xmin = 3-.8 * bw, xmax = 3+1.2*bw, ymin = 1.2, ymax = 1.2+8, data = df1[1, ], fill = \"gray80\", alpha = .5) + \r\n  annotate(\"text\", x = 3-bw, y = 8+1.45, label = \"Hidden poorly internally labeled account: -$8 billion\", size = 3, vjust = 0, hjust = 0, color = \"gray50\") + \r\n  \r\n  # Robinhood shares\r\n  geom_rect(xmin = 2-bw, xmax = 2+bw, ymin = h1-.472, ymax = h1, data = df1[1, ], fill = NA, color = \"black\", size = 1) + \r\n  geom_segment(x = 2-bw, xend = 2-1.4 * bw, y = h1-.472/2, yend = h1-.4, size = 1, color = \"black\") +\r\n  annotate(\"text\", x = 2-1.6*bw, y = h1-.4, label = \"Robinhood shares\", size = 4, hjust = 1) + \r\n  \r\n  # Stuff we made up\r\n  geom_rect(xmin = 2-bw, xmax = 2+bw, ymin = h3, ymax = h2, data = df1[1, ], fill = NA, color = \"black\", size = 1) + \r\n  geom_segment(x = 2-bw, xend = 2-1.4*bw, y = h2-.9, yend = h2-.8, size = 1, color = \"black\") +\r\n  annotate(\"text\", label = \"Stuff we made up\", x = 2-1.6*bw, y = h2-.6, size = 4, hjust = 1) + \r\n  \r\n  # TRUMPLOSE\r\n  geom_rect(xmin = 2-.8*bw, xmax = 2-.7*bw, ymin = h4-1.15, ymax = h4-1, data = df1[1, ], fill = NA, color = \"black\", size = 1) + \r\n  geom_segment(x = 2-.8*bw, xend = 2-1.5*bw, y = h4-1.075, yend = h4-1.2, size = 1, color = \"black\") +\r\n  annotate(\"text\", label = \"TRUMPLOSE\", x = 2-1.7*bw, y = h4-1.15, size = 4, hjust = 1) + \r\n  \r\n  # Note\r\n  annotate(\"text\", label = \"Note:\", x = 4-.2, y = 4.75, size = 3.25, fontface = \"bold\", hjust = 0) + \r\n  annotate(\"text\", label = \"all of these are rough values,\", x = 4-.4, y = 4, size = 2.75, hjust = 0) + \r\n  annotate(\"text\", label = \"and could be slightly off;\", x = 4-.35, y = 3.35, size = 2.5, hjust = 0) + \r\n  annotate(\"text\", label = \"there is also obviously a chance of typos\", x = 4-.4, y = 2.5, size = 2, hjust = 0) + \r\n  annotate(\"text\", label = \"etc.\", x = 4+.4, y = 1.75, size = 2, hjust = 0) + \r\n  \r\n  labs(title = \"There were many things I wish I could do differently than I did\") + \r\n  scale_fill_manual(labels = c(\"Illiquid: $3.2bn\", \"Less liquid: $5.4bn\", \"Liquid: $900mn\", \"\"), values = c(\"#a4b1ff\", \"#6679d8\", \"#1046b1\", \"#d1241a\")) + \r\n  scale_x_discrete(labels = c(\"\", \"Assets\\n\\\"$9.6bn\\\"\", \"Liabilities\\n-$8.9bn\", \"\")) +\r\n  guides(fill = guide_legend(override.aes = list(alpha = c(1, 1, 1, 0)))) + \r\n  theme(plot.title = element_text(size = 12, face = \"bold\", hjust = .5),\r\n        axis.title = element_blank(),\r\n        axis.text.x = element_text(size = 11, color = \"black\"),\r\n        axis.text.y = element_blank(),\r\n        axis.ticks = element_blank(),\r\n        legend.position = c(0, .5),\r\n        legend.background = element_blank(),\r\n        legend.justification = c(0, 1),\r\n        legend.title = element_blank(),\r\n        legend.text = element_text(size = 11),\r\n        legend.key = element_blank(),\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid = element_blank())\r\n\r\n\r\n\r\nI think this exercise really brings out the “grid” nature of ggplot. It may be painstaking but as long as you can place your rectangle or line or textbox in the x-y coordinate system, you can modify your chart in all sorts of fun ways.\r\n\r\n\r\n\r\n",
    "preview": "posts/2022-11-15-ftx/ftx_files/figure-html5/unnamed-chunk-6-1.png",
    "last_modified": "2022-11-28T22:16:22+08:00",
    "input_file": {},
    "preview_width": 1248,
    "preview_height": 768
  },
  {
    "path": "posts/2022-11-13-elon/",
    "title": "Visualizing Elon Musk's Twitter addiction",
    "description": "The world's busiest billionaire finds the time to tweet at all hours of the day",
    "author": [],
    "date": "2022-11-13",
    "categories": [],
    "contents": "\r\nElon Musk tweets a lot. Like, a lot. We can quantify it using this Kaggle dataset that contains all of Musk’s tweets between 27 January and 27 October 2022.\r\n\r\n\r\nlibrary(tidyverse)\r\nlibrary(lubridate)\r\nlibrary(ggplot2)\r\n\r\ndf <- read_csv(\"rawdata.csv\") %>%\r\n  arrange(Date) %>%\r\n  mutate(hour(Date) <- hour(Date) + 1)\r\n\r\n# Switch from UTC to UTC-6 (Texas)\r\nhour(df$Date) <- hour(df$Date) - 6\r\n\r\ndf <- df %>%\r\n  mutate(date = date(Date),\r\n         hour = hour(Date),\r\n         gap = difftime(Date, lag(Date), units = \"mins\"))\r\n\r\n# Tweets per day: nrow(df) / as.numeric(as.Date(\"2022-10-27\") - as.Date(\"2022-01-27\"))\r\n# Average time between tweets: mean(df$gap[-1])\r\n\r\n\r\nThe timestamps were in UTC, but since Musk seems to reside mostly in Texas, I switched the time zone to UTC-6.\r\nDuring this 10-month period, Musk sent out about 11 tweets per day. Put another way, he tweeted every 2 hours and 8 minutes for 10 months. Some of the tweets dabble in great power diplomacy, some are poop emojis.\r\nLooking at the sheer volume of tweets Musk produces, I got to wondering: when does this guy work? Elon Musk is famously a workaholic who claims to work 80-90 hours a week. But… is he just tweeting the whole time? Let’s investigate.\r\nFirst let’s chart his tweets per day to see what we’re dealing with.\r\n\r\n\r\nShow code\r\n\r\nggplot(df %>% count(date), aes(x = date, y = n)) + \r\n  geom_bar(stat = \"identity\", width = 1, fill = \"#1046b1\") +\r\n  scale_x_date(date_breaks = \"1 month\", date_labels = \"%b\") + \r\n  scale_y_continuous(breaks = c(0, 20, 40)) + \r\n  theme(axis.title = element_blank(),\r\n        axis.ticks = element_blank(),\r\n        axis.text.x = element_text(size = 10, margin = margin(5, 0, 0, 0)),\r\n        axis.text.y = element_text(size = 10, margin = margin(0, 5, 0, 0)),\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid.major.x = element_blank(),\r\n        panel.grid.minor.x = element_blank(),\r\n        panel.grid.minor.y = element_blank())\r\n\r\n\r\n\r\nInterestingly, Musk does take breaks from time to time, like a 10-day stretch in late June. Maybe work picked up?\r\nNow let’s plot an hourly histogram of his tweets.\r\n\r\n\r\nShow code\r\n\r\nggplot(df, aes(x = hour)) +\r\n  geom_histogram(aes(y = ..density..), binwidth = 1, fill = \"#1046b1\", color = \"gray97\", size = 2) + \r\n  scale_x_continuous(breaks = 0:23) + \r\n  scale_y_continuous(labels = function(x) paste0(100 * x, \"%\")) + \r\n  theme(axis.title = element_blank(),\r\n        axis.ticks = element_blank(),\r\n        axis.text.x = element_text(size = 10, margin = margin(5, 0, 0, 0)),\r\n        axis.text.y = element_text(size = 10, margin = margin(0, 5, 0, 0)),\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid.major.x = element_blank(),\r\n        panel.grid.minor.x = element_blank(),\r\n        panel.grid.minor.y = element_blank())\r\n\r\n\r\n\r\nWow. It looks like he tweets at pretty much all waking hours of the day. He also seems to not be getting much sleep, with the lull in tweets spanning just 3am to 6am.\r\nLooking through the dataset, what’s more remarkable is that most of his tweets are replies to other tweets. Anyone can tweet 11 tweets per day, but what Musk is doing involves actually browsing Twitter, reading other people’s tweets, and reacting to them. Constantly. All day. Everyday. I suppose an argument can be made that one so thoroughly immersed in the platform (to the point of crippling addiction) is actually well-placed to run said platform. But an argument can also be made that no, what, are you crazy, that’d be a horrible idea.\r\nHere’s a fun data viz exercise to end. Let’s color the bars according to the time of day, with nighttime in blue and daytime in yellow.\r\n\r\n\r\ndaycolors <- c(rep(\"#1046b1\", 5),  # 12am to 4am\r\n               rep(\"#9696d2\", 3),  # 5am to 7am\r\n               rep(\"#ffa600\", 12), # 8am to 7pm\r\n               rep(\"#9696d2\", 3),  # 8pm to 10pm\r\n               rep(\"#1046b1\", 1))  # 11pm\r\n\r\nggplot(df, aes(x = hour)) +\r\n  geom_histogram(aes(y = ..density..), \r\n                 binwidth = 1, \r\n                 fill = daycolors, \r\n                 color = \"gray97\",\r\n                 size = 2.5) + \r\n  labs(title = \"Time distribution of Elon Musk's tweets\",\r\n       subtitle = \"January to October 2022\") + \r\n  scale_x_continuous(breaks = 0:23, \r\n                     label = paste0(c(12, 1:12, 1:11), \":00\")) + \r\n  scale_y_continuous(labels = function(x) paste0(100 * x, \"%\")) + \r\n  theme(plot.title = element_text(size = 12, face = \"bold\", hjust = .5),\r\n        plot.subtitle = element_text(size = 11, hjust = .5, margin = margin(0, 0, 15, 0)),\r\n        axis.title = element_blank(),\r\n        axis.ticks = element_blank(),\r\n        axis.text.x = element_text(size = 10, angle = 90, hjust = 1, vjust = .5, margin = margin(5, 0, 0, 0)),\r\n        axis.text.y = element_text(size = 10, margin = margin(0, 5, 0, 0)),\r\n        legend.position = \"none\",\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid.major.x = element_blank(),\r\n        panel.grid.major.y = element_blank(),\r\n        panel.grid.minor.x = element_blank(),\r\n        panel.grid.minor.y = element_blank())\r\n\r\n\r\n\r\n\r\n\r\n\r\n",
    "preview": "posts/2022-11-13-elon/elon_files/figure-html5/unnamed-chunk-4-1.png",
    "last_modified": "2022-11-29T09:50:42+08:00",
    "input_file": {},
    "preview_width": 1440,
    "preview_height": 816
  },
  {
    "path": "posts/2022-11-10-dual-wield/",
    "title": "Should you dual wield y axes?",
    "description": "Points to keep in mind when resorting to a secondary axis",
    "author": [],
    "date": "2022-11-10",
    "categories": [],
    "contents": "\r\nConsider this: all charts are essentially squiggles on a Cartesian plane. There’s a horizontal, or x, axis and there’s a vertical, or y, axis. This implies that the underlying datasets ever only need two columns, corresponding to the two axes. Many chart enthusiasts seem to be guided by this principle, which is why they detest charts that violate this setup, like pie charts.\r\nAnother chart that maybe violates this setup are those with two different y axes, or dual axis charts. These are very popular. Today, Planning Secretary Arsenio Balisacan accompanied his tweet on the Philippine third quarter GDP numbers with this chart:\r\n\r\n\r\n\r\n\r\n\r\n\r\nWhat’s wrong with it?\r\nThe first problem is that there isn’t really a reason why it has to be a dual axis chart at all. The level of real GDP is not meaningful to most people and visualizing it doesn’t provide much insight.\r\nThe second problem is that it’s sloppily made. In the legend, “Real GDP” (the bars) is on the left and “GDP growth” (the line) is on the right, so the natural inclination is to use the left axis for the bars and the right axis for the line. But woe to you if you do—the positions are reversed. This is because for “combo charts” in Excel (i.e. where you combine two chart types), bar layers always go first before lines, hence they are listed first in the legend.1 But you can choose which axis the bar series is assigned to, so it should have been assigned to the left one.\r\nMore importantly: the two axes clash. Look at 5.0 on the left axis. If you follow the grid line all the way to the right axis, you get… 4.something. You quickly realize that the grid lines really just mark the axis labels on the left, not the right. The right axis exists in its own parallel grid in the nether regions of the chart. That’s confusing! This is again a trait of Excel. If you tick the check box that puts a series on the secondary axis, it automatically scales its axis independent of the primary axis. So you basically end up with two charts sharing the same x axis superimposed on top of each other.\r\nBelow is my own quick fix of the chart (data source here).\r\n\r\n\r\nShow code\r\n\r\nlibrary(tidyverse)\r\nlibrary(tsibble)\r\nlibrary(ggplot2)\r\n\r\ndf <- read_csv(\"phgdp.csv\") %>%\r\n  mutate(date = as.Date(date, format = \"%d/%m/%Y\"), \r\n         quarter = yearquarter(date),\r\n         qtr = as.character(quarter),\r\n         growth = 100 * (gdp / lag(gdp, 4) - 1))\r\n\r\nggplot(subset(df, date >= \"2019-03-01\")) + \r\n  geom_bar(aes(x = qtr, y = gdp / 1000000, fill = \"LHS - Real GDP (in constant 2018 trillion pesos)\"), stat = \"identity\", width = .5) + \r\n  geom_line(aes(x = qtr, y = growth / 5 + 4, color = \"RHS - GDP growth (in %)\"), group = 1, size = 1.5) + \r\n  geom_point(aes(x = qtr, y = growth / 5 + 4, color = \"RHS - GDP growth (in %)\", line = \"RHS - GDP growth (in %)\"), size = 3.5) + \r\n  geom_hline(yintercept = 0, size = .25, color = \"gray25\") + \r\n  scale_fill_manual(values = \"#fcc954\") +\r\n  scale_color_manual(values = \"#0b3f90\") + \r\n  guides(fill = guide_legend(order = 1)) + \r\n  scale_y_continuous(limits = c(0, 7), breaks = 0:7,\r\n                     sec.axis = sec_axis(~ (. - 4) * 5, breaks = seq(-20, 15, 5))) + \r\n  theme(axis.title = element_blank(),\r\n        axis.text.x = element_text(size = 10, angle = 90, margin = margin(-3, 0, 0, 0)),\r\n        axis.text.y = element_text(size = 10, margin = margin(0, 5, 0, 0)),\r\n        axis.ticks = element_blank(),\r\n        legend.position = \"top\",\r\n        legend.title = element_blank(),\r\n        legend.key = element_blank(),\r\n        legend.key.height = unit(.75, \"lines\"),\r\n        legend.key.width = unit(1.5, \"lines\"),\r\n        legend.text = element_text(size = 11),\r\n        panel.background = element_blank(),\r\n        panel.grid.major.x = element_blank(),\r\n        panel.grid.major.y = element_line(size = .25, color = \"gray85\"),\r\n        panel.grid.minor.x = element_blank(),\r\n        panel.grid.minor.y = element_blank())\r\n\r\n\r\n\r\nThere’s still one last problem with this chart, which is that the right y axis really ought to cross the x axis at zero. Positive growth rates fundamentally differ from negative growth rates, but a quick glance at the chart gives the impression that Philippine growth just took a dip in 2020. But! If you cross the right y axis at zero, the left y axis will have to extend to the negative numbers. This would make no sense for GDP. So there’s the dilemma: one y axis ends up compromising the other. I don’t know if there’s a way to fix this.\r\nI personally don’t have anything against dual axis charts, and I have used them a lot in my work. What I am against are sloppily made charts, and perhaps, by being inherently more complex, sloppiness in dual axis charts tends to be extra noticeable.\r\nOne essential to keep in mind is that both y axes must coexist in the same Cartesian plane, meaning one is just a transformation of the other. In the chart I made, \\(y_{\\text{right}} = ( y_{\\text{left}} - 4 ) \\times 5\\). This is something you manually have to specify in ggplot, making it harder to make dual axis charts there. But that’s by design. Excel makes it too easy, and so you get people hitting that secondary axis check box and calling it a day.\r\n\r\nFor some reason, Excel is adamant that you should never be able to change the order of chart layers, or the order of legend items.↩︎\r\n",
    "preview": "posts/2022-11-10-dual-wield/dual-wield_files/figure-html5/unnamed-chunk-3-1.png",
    "last_modified": "2022-11-29T10:12:19+08:00",
    "input_file": {},
    "preview_width": 1440,
    "preview_height": 768
  },
  {
    "path": "posts/2022-11-08-metro-manila-subway/",
    "title": "Mapping the Metro Manila subway",
    "description": "In a fit of wishful thinking, I use Leaflet to map the Metro Manila subway as if it existed",
    "author": [],
    "date": "2022-11-08",
    "categories": [],
    "contents": "\r\nToday I’ll experiment with making maps via leaflet, which I’m using for the first time. I’m relying mainly on this tutorial.\r\n\r\n\r\nlibrary(tidyverse)\r\nlibrary(leaflet)\r\n\r\n\r\nBelow is a map pointing out some of the planned stations of the future Metro Manila Subway, which will be built… sometime… maybe? Back in June the first tunnel boring machine was “ceremonially lowered” but no digging has actually taken place.\r\nAnyway, I map the stations from Quirino Highway to 11th Avenue in BGC. I got the locations from trawling through news articles and project documents, then I used Google Maps to get their coordinates.\r\n\r\n\r\nleaflet(options = leafletOptions(minZoom = 10, maxZoom = 15)) %>%\r\n  addTiles() %>%\r\n  addMarkers(lng=121.028460, lat=14.689541, label=\"Quirino Highway Station\") %>%\r\n  addMarkers(lng=121.032355, lat=14.676936, label=\"Tandang Sora Station\") %>%\r\n  addMarkers(lng=121.035685, lat=14.654850, label=\"North Avenue Station\") %>%\r\n  addMarkers(lng=121.037591, lat=14.644747, label=\"Quezon Avenue Station\") %>%\r\n  addMarkers(lng=121.051628, lat=14.640692, label=\"East Avenue Station\") %>%\r\n  addMarkers(lng=121.065282, lat=14.627151, label=\"Anonas Station\") %>%\r\n  addMarkers(lng=121.069868, lat=14.613690, label=\"Camp Aguinaldo Station\") %>%\r\n  addMarkers(lng=121.063565, lat=14.588103, label=\"Ortigas Station\") %>%\r\n  addMarkers(lng=121.061238, lat=14.575162, label=\"Shaw Station\") %>%\r\n  addMarkers(lng=121.055859, lat=14.558327, label=\"11th Avenue Station\")\r\n\r\n\r\n\r\nAnd here’s the map! It’s fine? It’s a little busy, so let’s change the map tile from the default OpenStreetMap to a nice minimalist one from this list.\r\n\r\n\r\nleaflet(options = leafletOptions(minZoom = 10, maxZoom = 15)) %>%\r\n  addProviderTiles(providers$CartoDB.Voyager) %>%\r\n  addMarkers(lng=121.028460, lat=14.689541, label=\"Quirino Highway Station\") %>%\r\n  addMarkers(lng=121.032355, lat=14.676936, label=\"Tandang Sora Station\") %>%\r\n  addMarkers(lng=121.035685, lat=14.654850, label=\"North Avenue Station\") %>%\r\n  addMarkers(lng=121.037591, lat=14.644747, label=\"Quezon Avenue Station\") %>%\r\n  addMarkers(lng=121.051628, lat=14.640692, label=\"East Avenue Station\") %>%\r\n  addMarkers(lng=121.065282, lat=14.627151, label=\"Anonas Station\") %>%\r\n  addMarkers(lng=121.069868, lat=14.613690, label=\"Camp Aguinaldo Station\") %>%\r\n  addMarkers(lng=121.063565, lat=14.588103, label=\"Ortigas Station\") %>%\r\n  addMarkers(lng=121.061238, lat=14.575162, label=\"Shaw Station\") %>%\r\n  addMarkers(lng=121.055859, lat=14.558327, label=\"11th Avenue Station\")\r\n\r\n\r\n\r\nNeat. I’ll revisit this later on to see what else I can add.\r\nUpdate 17 November 2022: Transportation Undersecretary Cesar Chavez has said that “the actual excavation is on December 12”. He added: “Actually, this is for real. The excavation is real.” Well, there you have it. The excavation is “real”.\r\n\r\n\r\n\r\n",
    "preview": "posts/2022-11-08-metro-manila-subway/subwaymap.jpg",
    "last_modified": "2022-11-29T10:05:26+08:00",
    "input_file": {}
  },
  {
    "path": "posts/2022-11-05-wdi/",
    "title": "Exercises in plotting WDI data",
    "description": "Pull the data with R instead of downloading spreadsheet after spreadsheet",
    "author": [],
    "date": "2022-11-05",
    "categories": [],
    "contents": "\r\nIn the old days I used to download WDI datasets in Excel format and point-and-click my way to a neat little chart. Now I want to try using the WDI package and some ggplot wizardry.\r\n\r\n\r\nlibrary(tidyverse)\r\nlibrary(ggplot2)\r\nlibrary(WDI)\r\n\r\n\r\nTo start, let’s try plotting the GDP per capita of the Philippines and Vietnam in constant 2015 US$.\r\n\r\n\r\ndf <- WDI(country = c(\"PH\",\"VN\"),\r\n          indicator = \"NY.GDP.PCAP.KD\",\r\n          start = 1990) %>% \r\n  as_tibble()\r\n\r\nggplot(df, aes(x = year, y = NY.GDP.PCAP.KD, color = country)) +\r\n  geom_line()\r\n\r\n\r\n\r\nGreat. Now let’s try to get a cleaner chart by removing everything we don’t need: the axis labels, the legend title, the vertical grid lines, the tick marks. Let’s also add a chart title.\r\n\r\n\r\nggplot(df, aes(x = year, y = NY.GDP.PCAP.KD, color = country)) +\r\n  geom_line() +\r\n  labs(title = \"GDP per capita in constant 2015 US$\") +\r\n  theme(axis.title = element_blank(),\r\n        axis.ticks = element_blank(),\r\n        legend.position = \"right\",\r\n        legend.title = element_blank(),\r\n        panel.grid.major.x = element_blank(),\r\n        panel.grid.minor.x = element_blank(),\r\n        panel.grid.minor.y = element_blank())\r\n\r\n\r\n\r\nIt’s a serviceable chart, but not a particularly attractive chart. Let’s spend some more time glamming it up. The numbers on the y-axis could use a thousands separator. The plot lines could be a little thicker. We can also make tweaks to the text sizes, the colors, the margins, and so forth.\r\n\r\n\r\nShow code\r\n\r\nggplot(df, aes(x = year, y = NY.GDP.PCAP.KD, color = country)) +\r\n  geom_line(size = 1) +\r\n  labs(title = \"GDP per capita in constant 2015 US$\") +\r\n  scale_color_manual(values = c(\"#076fe4\", \"#f2500d\")) + \r\n  scale_y_continuous(label = function(x) prettyNum(x, big.mark = \",\", scientific = FALSE)) + \r\n  theme(aspect.ratio = .7,\r\n        axis.title = element_blank(),\r\n        axis.ticks = element_blank(),\r\n        axis.text.x = element_text(size = 10, margin = margin(5, 0, 0, 0)),\r\n        axis.text.y = element_text(size = 10, margin = margin(0, 5, 0, 0)),\r\n        plot.title = element_text(size = 12, hjust = .5, face = \"bold\", margin = margin(0, 0, 10, 0)),\r\n        legend.position = \"right\",\r\n        legend.title = element_blank(),\r\n        legend.text = element_text(size = 11),\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid.major.x = element_blank(),\r\n        panel.grid.minor.x = element_blank(),\r\n        panel.grid.minor.y = element_blank())\r\n\r\n\r\n\r\nNow this to me is pleasing to the eye. A document populated with charts like this—as opposed to charts like the first two above—would be much more motivating to read.\r\nHere’s a second exercise. I think one useful way to categorize countries is according to whether they are big and rich, big and poor, small and rich, or small and poor. We can visualize this in a scatterplot with population on one axis and GDP per capita on the other. Let’s load up the data and plot the scatter.\r\n\r\n\r\ndf <- WDI(country = \"all\",\r\n          indicator = c(\"gpc\" = \"NY.GDP.PCAP.KD\", \r\n                        \"pop\" = \"SP.POP.TOTL\"),\r\n          start = 2015,\r\n          end = 2015,\r\n          extra = TRUE) %>% \r\n  as_tibble() %>%\r\n  filter(region != \"Aggregates\") %>%\r\n  select(country, gpc, pop) %>%\r\n  drop_na()\r\n\r\nggplot(df, aes(x = pop, y = gpc)) +\r\n  geom_point()\r\n\r\n\r\n\r\nWhat an atrocious chart! To make it comprehensible, we’ll need to re-express the axes in log scale first.\r\n\r\n\r\nggplot(df, aes(x = log10(pop), y = log2(gpc))) +\r\n  geom_point() + \r\n  scale_x_continuous(name = \"Population\",\r\n                     breaks = c(log10(10^4), log10(10^5), log10(10^6), log10(10^7), log10(10^8), log10(10^9)),\r\n                     label = c(\"10,000\", \"100,000\", \"1 million\", \"10 million\", \"100 million\", \"1 billion\")) +\r\n  scale_y_continuous(name = \"GDP per capita constant 2015 US$\",\r\n                     breaks = c(log2(500), log2(1500), log2(10000), log2(30000)),\r\n                     label = function(x) prettyNum(2^x, big.mark = \",\", scientific = FALSE))\r\n\r\n\r\n\r\nBetter! Let’s make further tweaks to the colors and so on to make it more attractive. In addition, let’s include some dividing lines to group big, small, rich, and poor countries. Some sensible definitions would be that “big” countries are those with 100 million people and above while “rich” countries are those with GDP per capita of $30,000 and above.\r\n\r\n\r\nShow code\r\n\r\nggplot(df, aes(x = log10(pop), y = log2(gpc))) +\r\n  geom_point(shape = 16, size = 3, color = \"#076fe4\") + \r\n  labs(title = \"Big and small, rich and poor\") +\r\n  geom_vline(xintercept = log10(10^8), size = .5, linetype = \"dashed\", color = \"gray50\") +\r\n  geom_hline(yintercept = log2(30000), size = .5, linetype = \"dashed\", color = \"gray50\") + \r\n  scale_x_continuous(name = \"Population\",\r\n                     breaks = c(log10(10^4), log10(10^5), log10(10^6), log10(10^7), log10(10^8), log10(10^9)),\r\n                     label = c(\"10,000\", \"100,000\", \"1 million\", \"10 million\", \"100 million\", \"1 billion\")) +\r\n  scale_y_continuous(name = \"GDP per capita constant 2015 US$\",\r\n                     breaks = c(log2(500), log2(1500), log2(10000), log2(30000)),\r\n                     label = function(x) prettyNum(2^x, big.mark = \",\", scientific = FALSE)) + \r\n  theme(axis.title = element_text(size = 11),\r\n        axis.title.x = element_text(margin = margin(10, 0, 0, 0)),\r\n        axis.title.y = element_text(margin = margin(0, 10, 0, 0)),\r\n        axis.text.x = element_text(size = 10, margin = margin(5, 0, 0, 0)),\r\n        axis.text.y = element_text(size = 10, margin = margin(0, 5, 0, 0)),\r\n        axis.ticks = element_blank(),\r\n        plot.title = element_text(size = 12, hjust = .5, face = \"bold\", margin = margin(0, 0, 10, 0)),\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid = element_blank())\r\n\r\n\r\n\r\nAnd here’s the interesting result. Under this set of definitions, there are really only two big and rich countries: the United States and Japan. The biggest small and rich country is Germany, with a population of 82 million, while the richest small and poor country is Mexico, with a GDP per capita of $9,600. In short, no country in the near future is expected to join the big-and-rich club.1\r\nNow let’s make some finishing touches to the chart. First, let’s add the labels “big”, “small”, “rich”, and “poor” on either side of the dashed lines to make it clear what they’re indicating. Second, let’s bold the axis labels “30,000” and “100 million” to highlight the chosen thresholds for bigness and richness. Third, let’s label the points for the U.S., Japan, Germany, and Mexico to facilitate the discussion accompanying the chart. We also highlight these four points by making all other points transparent.\r\n\r\n\r\nShow code\r\n\r\nggplot(df, aes(x = log10(pop), y = log2(gpc))) +\r\n  geom_point(shape = 16, size = 3, color = \"#076fe4\", alpha = ifelse(df$country %in% c(\"United States\", \"Japan\", \"Germany\", \"Mexico\"), 1, .25)) +\r\n  labs(title = \"Big and small, rich and poor\") +\r\n  \r\n  # Dashed lines\r\n  geom_vline(xintercept = log10(10^8), size = .5, linetype = \"dashed\", color = \"gray50\") +\r\n  geom_hline(yintercept = log2(30000), size = .5, linetype = \"dashed\", color = \"gray50\") + \r\n  annotate(\"text\", x = log10(10^8) + .05, y = log2(200000), hjust = 0, label = \"big\", size = 3.5, color = \"gray50\") +\r\n  annotate(\"text\", x = log10(10^8) - .05, y = log2(200000), hjust = 1, label = \"small\", size = 3.5, color = \"gray50\") +\r\n  annotate(\"text\", x = log10(10.5^9), y = log2(30000) + .2, vjust = 0, label = \"rich\", size = 3.5, color = \"gray50\") +\r\n  annotate(\"text\", x = log10(10.5^9), y = log2(30000) - .15, vjust = 1, label = \"poor\", size = 3.5, color = \"gray50\") +\r\n  \r\n  # Highlighted points\r\n  annotate(\"text\", x = log10(df$pop[df$country == \"United States\"]), y = log2(df$gpc[df$country == \"United States\"]) + .4, hjust = 0, vjust = 0, label = \"United States\", size = 3.5, fontface = \"bold\") + \r\n  annotate(\"text\", x = log10(df$pop[df$country == \"Japan\"]) + .1, y = log2(df$gpc[df$country == \"Japan\"]), hjust = 0, vjust = 0, label = \"Japan\", size = 3.5, fontface = \"bold\") + \r\n  annotate(\"text\", x = log10(df$pop[df$country == \"Germany\"]), y = log2(df$gpc[df$country == \"Germany\"]) + .4, hjust = .5, vjust = 0, label = \"Germany\", size = 3.5, fontface = \"bold\") + \r\n  annotate(\"text\", x = log10(df$pop[df$country == \"Mexico\"]), y = log2(df$gpc[df$country == \"Mexico\"]) + .4, hjust = .5, vjust = 0, label = \"Mexico\", size = 3.5, fontface = \"bold\") + \r\n  \r\n  scale_x_continuous(name = \"Population\",\r\n                     breaks = c(log10(10^4), log10(10^5), log10(10^6), log10(10^7), log10(10^8), log10(10^9)),\r\n                     label = c(\"10,000\", \"100,000\", \"1 million\", \"10 million\", \"100 million\", \"1 billion\")) +\r\n  scale_y_continuous(name = \"GDP per capita constant 2015 US$\",\r\n                     breaks = c(log2(500), log2(1500), log2(10000), log2(30000)),\r\n                     label = function(x) prettyNum(2^x, big.mark = \",\", scientific = FALSE)) + \r\n  theme(axis.title = element_text(size = 11),\r\n        axis.title.x = element_text(margin = margin(10, 0, 0, 0)),\r\n        axis.title.y = element_text(margin = margin(0, 10, 0, 0)),\r\n        axis.text.x = element_text(size = 10, margin = margin(5, 0, 0, 0), face = c(\"plain\", \"plain\", \"plain\", \"plain\", \"bold\", \"plain\")),\r\n        axis.text.y = element_text(size = 10, margin = margin(0, 5, 0, 0), face = c(\"plain\", \"plain\", \"plain\", \"bold\")),\r\n        axis.ticks = element_blank(),\r\n        plot.title = element_text(size = 12, hjust = .5, face = \"bold\", margin = margin(0, 0, 10, 0)),\r\n        panel.background = element_rect(fill = \"gray97\"),\r\n        panel.grid = element_blank())\r\n\r\n\r\n\r\nAnd here’s the final chart!\r\n\r\nNot that this should be taken too seriously! The thresholds I used are completely arbitrary.↩︎\r\n",
    "preview": "posts/2022-11-05-wdi/wdi_files/figure-html5/unnamed-chunk-8-1.png",
    "last_modified": "2022-11-29T09:52:40+08:00",
    "input_file": {},
    "preview_width": 1248,
    "preview_height": 768
  }
]
